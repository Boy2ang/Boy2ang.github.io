<!-- build time:Wed Nov 04 2020 17:16:18 GMT+0800 (GMT+08:00) --><!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 4.2.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="//fonts.lug.ustc.edu.cn/css?family=Monda:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:new URL("https://Boy2ang.github.io").hostname,root:"/",scheme:"Gemini",version:"7.6.0",exturl:!1,sidebar:{position:"left",display:"post",padding:66,offset:12,onmobile:!1},copycode:{enable:!0,show_result:!0,style:null},back2top:{enable:!0,sidebar:!1,scrollpercent:!0},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!1,pangu:!1,algolia:{appID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},path:"search.xml",motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}}}</script><meta name="description" content="摘要：此篇详细介绍了从零搭建K8S集群，用的是Ubuntu的系统。装K8S并不难，难的是依赖的系统框架等由于版本冲突导致很难安装下去。"><meta property="og:type" content="article"><meta property="og:title" content="持续集成&#x2F;k8s集群安装"><meta property="og:url" content="https://boy2ang.github.io/posts/2326275321/index.html"><meta property="og:site_name" content="HELP ME HELP YOU"><meta property="og:description" content="摘要：此篇详细介绍了从零搭建K8S集群，用的是Ubuntu的系统。装K8S并不难，难的是依赖的系统框架等由于版本冲突导致很难安装下去。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://ybvip.oss-cn-shanghai.aliyuncs.com/blog/20200816154529.png"><meta property="og:image" content="https://ybvip.oss-cn-shanghai.aliyuncs.com/blog/20200816155725.png"><meta property="og:image" content="https://ybvip.oss-cn-shanghai.aliyuncs.com/blog/20200816160114.png"><meta property="og:image" content="https://ybvip.oss-cn-shanghai.aliyuncs.com/blog/20200925181222.png"><meta property="og:image" content="https://ybvip.oss-cn-shanghai.aliyuncs.com/blog/20200925181252.png"><meta property="article:published_time" content="2020-11-04T07:56:55.738Z"><meta property="article:modified_time" content="2020-11-04T09:05:59.334Z"><meta property="article:author" content="YB"><meta property="article:tag" content="K8S集群安装"><meta property="article:tag" content="容器化部署"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://ybvip.oss-cn-shanghai.aliyuncs.com/blog/20200816154529.png"><link rel="canonical" href="https://boy2ang.github.io/posts/2326275321/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0,isPage:!1,isArchive:!1}</script><title>持续集成/k8s集群安装 | HELP ME HELP YOU</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-meta"><div><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">HELP ME HELP YOU</span> <span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">记录人生的点点滴滴</p></div><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签<span class="badge">29</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类<span class="badge">16</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档<span class="badge">29</span></a></li><li class="menu-item menu-item-commonweal"><a href="/404/" rel="section"><i class="fa fa-fw fa-heartbeat"></i>公益 404</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="site-search"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="搜索..." spellcheck="false" type="text" id="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"></div></div><div class="search-pop-overlay"></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div><a href="https://github.com/Boy2ang" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content"><div class="posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://boy2ang.github.io/posts/2326275321/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="YB"><meta itemprop="description" content="年岁是我的闹钟"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="HELP ME HELP YOU"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">持续集成/k8s集群安装</h1><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-11-04 07:56:55 / 修改时间：09:05:59" itemprop="dateCreated datePublished" datetime="2020-11-04T07:56:55Z">2020-11-04</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90/" itemprop="url" rel="index"><span itemprop="name">持续集成</span> </a></span></span><span id="/posts/2326275321/" class="post-meta-item leancloud_visitors" data-flag-title="持续集成/k8s集群安装" title="热度"><span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="post-meta-item-text">热度：</span> <span class="leancloud-visitors-count"></span> <span>℃</span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-comment-o"></i> </span><span class="post-meta-item-text">Valine：</span> <a title="valine" href="/posts/2326275321/#comments" itemprop="discussionUrl"><span class="post-comments-count valine-comment-count" data-xid="/posts/2326275321/" itemprop="commentCount"></span></a></span> <span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>53k 字</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>48 分钟</span></span><div class="post-description">摘要：此篇详细介绍了从零搭建K8S集群，用的是Ubuntu的系统。装K8S并不难，难的是依赖的系统框架等由于版本冲突导致很难安装下去。</div></div></header><div class="post-body" itemprop="articleBody"><a id="more"></a><h1>一、Kubernetes概述</h1><h2 id="1、什么是k8s">1、什么是k8s</h2><p>Kubernetes（K8s）是Google在2014年发布的一个开源项目。</p><p>​	据说Google的数据中心里运行着20多亿个容器，而且Google十年多前就开始使用容器技术。</p><p>​	最初，Google开发了一个叫Borg的系统（现在命名为Omega）来调度如此庞大数量的容器和工作负载。在积累了这么多年的经验后，Google决定重写这个容器管理系统，并将其贡献到开源社区，让全世界都能受益。</p><p>​	这个项目就是Kubernetes。简单地讲，Kubernetes是Google Omega的开源版本。</p><p>​	从2014年第一个版本发布以来，Kubernetes迅速获得开源社区的追捧，包括Red Hat、VMware、Canonical在内的很多有影响力的公司加入到开发和推广的阵营。目前Kubernetes已经成为发展最快、市场占有率最高的容器编排引擎产品。</p><h2 id="2、Kubernetes解决了什么问题">2、Kubernetes解决了什么问题</h2><ul><li>通过 Kubernetes，分布式系统工具将拥有网络效应。每当人们为 Kubernetes 制作出的新的工具，都会让所有其他工具更完善。因此，这进一步巩固了 Kubernetes 的标准地位。</li><li>云提供商并非可替换的商品。不同的云提供的服务会变得越来越独特和不同。如果可以访问不同的云提供商提供的不同服务，那么企业将因此受益。</li><li>当多节点应用与单节点应用一样可靠时，我们将看到定价模型的变化。</li><li>这就是为什么我会被 Kubernetes 洗脑的原因，它是跨越异构系统的一个标准层。</li><li>将来，我们会像讨论编译器和操作系统内核一样讨论 Kubernetes。 Kubernetes 将会是低层级的管路系统，而不在普通应用开发人员的视野之内。</li></ul><p>Kubernetes 已成为部署分布式应用的标准方式。在不远的将来，任何新成立的互联网公司都将用到 Kubernetes，无论其是否意识到这点。许多旧应用也正在迁移到 Kubernete</p><h1>二、环境</h1><h2 id="2-1-部署软件环境版本">2.1 部署软件环境版本</h2><p>操作系统: <code>Ubuntu 18.10</code> (本教程采用server版本)</p><p>Docker： <code>docker-ce 18.06</code></p><p>Kubernetes: <code>k8s 1.13.1</code></p><h2 id="2-2-Ubuntu搭建研发环境">2.2 Ubuntu搭建研发环境</h2><p>我们直接下载Unbuntu18.10-server版本，server版本的好处是没有Desktop, 可以节省资源。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http://mirrors.aliyun.com/ubuntu-releases/18.10/ubuntu-18.10-live-server-amd64.iso</span><br></pre></td></tr></table></figure><h2 id="2-3-Ubuntu安装过程">2.3 Ubuntu安装过程</h2><h3 id="2-3-1-创建虚拟机">2.3.1 创建虚拟机</h3><p>vm15</p><h3 id="2-3-2-图形界面安装方式">2.3.2 图形界面安装方式</h3><ol><li><p>选择英文语言</p></li><li><p>英文键盘</p><p>设置国内镜像源头 <code>http://mirrors.aliyun.com/ubuntu/</code> 注意末尾的斜线</p><p>坑：这个地址是proxy的地址，确定后第二个地址默认，如果什么都不填安装的时候会一直循环报错</p></li></ol><h2 id="2-4-修改主机名">2.4 修改主机名</h2><p>修改主机名称</p><ol><li>使用root用户登录</li><li>打开配置文件<code>vim /etc/cloud/cloud.cfg</code></li><li>修改配置<code>preserve_hostname: true</code>重启</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> shutdown -r now</span></span><br></pre></td></tr></table></figure><h2 id="2-5-配置静态IP-永久有效-NAT模式">2.5 配置静态IP(永久有效)(NAT模式)</h2><ol><li>使用root用户登录Linux，如下以Node2为例</li><li><code>vim /etc/netplan/50-cloud-init.yaml</code></li><li>参考如下截图修改配置文件</li></ol><ul><li>UbuntuMaster <code>172.16.235.146</code></li><li>UbuntuNode1 <code>172.16.235.147</code></li><li>UbuntuNode2 <code>172.16.235.148</code></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">network:</span><br><span class="line">    ethernets:</span><br><span class="line">        ens33:</span><br><span class="line">            addresses: [192.168.236.177/24]</span><br><span class="line">            dhcp4: <span class="literal">false</span></span><br><span class="line">            gateway4: 192.168.236.2</span><br><span class="line">            nameservers:</span><br><span class="line">                       addresses: [192.168.236.2]</span><br><span class="line">            optional: <span class="literal">true</span></span><br><span class="line">    version: 2</span><br></pre></td></tr></table></figure><p>或者动态获取</p><p>什么都不配，不推荐，重启vm后host地址都会改变</p><h2 id="2-6-修改hosts">2.6 修改hosts</h2><p>使用root用户登录</p><ol><li><p>打开hosts文件 <code>vim /etc/hosts</code></p></li><li><p>输入如下内容</p></li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">192.168.236.177 master</span><br></pre></td></tr></table></figure><p>这个ip是当前桥接或者NAT分配的IP地址</p><ol start="3"><li>重启机器<code>shutdown -r now</code></li></ol><h2 id="ip应用启动：">ip应用启动：</h2><p><code>$netplan apply</code></p><p>记得关闭防火墙哦，ubuntu封装了命令，简化了操作</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo ufw <span class="built_in">disable</span> （Uncomplicated FireWall）</span></span><br></pre></td></tr></table></figure><h1>三、Docker-CE安装及配置</h1><h2 id="3-1-Docker简介">3.1 Docker简介</h2><h3 id="3-1-1-docker介绍">3. 1.1 docker介绍</h3><ul><li><p>docker是什么 ?</p><blockquote><p>Docker 是一个开源的应用<strong>容器引擎</strong>，是直接运行在宿主操作系统之上的一个容器，使用沙箱机制完全虚拟出一个完整的操作，容器之间不会有任何接口，从而让容器与宿主机之间、容器与容器之间隔离的更加彻底。每个容器会有自己的权限管理，独立的网络与存储栈，及自己的资源管理能，使同一台宿主机上可以友好的共存多个容器。</p></blockquote></li></ul><h2 id="3-2-配置国内源">3.2 配置国内源</h2><h3 id="3-2-1-基础准备">3.2.1 基础准备</h3><ol><li>Docker 要求 Ubuntu 系统的内核版本高于 3.10 ，查看本页面的前提条件来验证你的 Ubuntu 版本是否支持 Docker。</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">uname -r </span><br><span class="line">4.18.0-21-generic(主版本必须保持一致)</span><br></pre></td></tr></table></figure><ol start="2"><li>查看更换国内源</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cp /etc/apt/sources.list /etc/apt/sources.list.bak</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat /etc/apt/sources.list</span></span><br></pre></td></tr></table></figure><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">   <span class="comment"># 阿里源 这个版本是18.04的，而本地版本是18.10，部分软件有些不兼容，想后面的docker-compose就有问题，最后买的腾讯实例用yum装的</span></span><br><span class="line">deb http:<span class="regexp">//mi</span>rrors.aliyun.com<span class="regexp">/ubuntu/</span> xenial main</span><br><span class="line">deb-src http:<span class="regexp">//mi</span>rrors.aliyun.com<span class="regexp">/ubuntu/</span> xenial main</span><br><span class="line"></span><br><span class="line">deb http:<span class="regexp">//mi</span>rrors.aliyun.com<span class="regexp">/ubuntu/</span> xenial-updates main</span><br><span class="line">deb-src http:<span class="regexp">//mi</span>rrors.aliyun.com<span class="regexp">/ubuntu/</span> xenial-updates main</span><br><span class="line"></span><br><span class="line">deb http:<span class="regexp">//mi</span>rrors.aliyun.com<span class="regexp">/ubuntu/</span> xenial universe</span><br><span class="line">deb-src http:<span class="regexp">//mi</span>rrors.aliyun.com<span class="regexp">/ubuntu/</span> xenial universe</span><br><span class="line">deb http:<span class="regexp">//mi</span>rrors.aliyun.com<span class="regexp">/ubuntu/</span> xenial-updates universe</span><br><span class="line">deb-src http:<span class="regexp">//mi</span>rrors.aliyun.com<span class="regexp">/ubuntu/</span> xenial-updates universe</span><br><span class="line"></span><br><span class="line">deb http:<span class="regexp">//mi</span>rrors.aliyun.com<span class="regexp">/ubuntu/</span> xenial-security main</span><br><span class="line">deb-src http:<span class="regexp">//mi</span>rrors.aliyun.com<span class="regexp">/ubuntu/</span> xenial-security main</span><br><span class="line">deb http:<span class="regexp">//mi</span>rrors.aliyun.com<span class="regexp">/ubuntu/</span> xenial-security universe</span><br><span class="line">deb-src http:<span class="regexp">//mi</span>rrors.aliyun.com<span class="regexp">/ubuntu/</span> xenial-security universe</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 跳到首行</span></span><br><span class="line">gg </span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除所有</span></span><br><span class="line">dG</span><br><span class="line"><span class="meta">#</span><span class="bash"> 准备粘贴，直接粘贴格式会乱</span></span><br><span class="line">:set paste 然后按i</span><br><span class="line"><span class="meta">#</span><span class="bash"> ctrl <span class="built_in">shift</span> v （final shell 快捷键）</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 全局替换</span></span><br><span class="line">:%s/源字符串/目标字符串/g</span><br></pre></td></tr></table></figure><p>补充：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 查看当前linux版本 , -a表示列出所有选项  1sb ： linux standard Base</span></span><br><span class="line">lsb_release -a</span><br><span class="line"><span class="meta">#</span><span class="bash"> CodeName 就是换源中的代码，可以看到xenial 和 cosmic不一致，所以会导致有些apt-get 下不下来</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 另外LSB 表示long term support 长期支持版，这个18.10版本此时不再维护了，阿里，中科大的源有些的也过期了，所以不好找</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 以后按照ubuntu是要选择长期支持版，另外看看国内源也是否支持这个版本</span></span><br><span class="line">master@master:/etc/apt$ lsb_release -a</span><br><span class="line">No LSB modules are available.</span><br><span class="line">Distributor ID: Ubuntu</span><br><span class="line">Description:    Ubuntu 18.10</span><br><span class="line">Release:        18.10</span><br><span class="line">Codename:       cosmic</span><br></pre></td></tr></table></figure><p><a href="https://blog.csdn.net/anxhh/article/details/88528479?utm_medium=distribute.pc_relevant_t0.none-task-blog-BlogCommendFromMachineLearnPai2-1.channel_param&amp;depth_1-utm_source=distribute.pc_relevant_t0.none-task-blog-BlogCommendFromMachineLearnPai2-1.channel_param" target="_blank" rel="noopener">换源教程</a></p><pre><code>可以先复制阿里的，然后vim 进入全删掉，然后粘贴
</code></pre><p>一定要确保所有源都换完，否则有些依赖下载会报错</p><ol start="3"><li>安装<code>curl</code></li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">apt-get update &amp;&amp; apt-get install -y curl telnet wget man \</span><br><span class="line">apt-transport-https \</span><br><span class="line">ca-certificates \</span><br><span class="line">software-properties-common vim</span><br></pre></td></tr></table></figure><h3 id="3-2-3-手动安装Docker-离线安装">3.2.3 手动安装Docker(离线安装)</h3><ol><li>下载<code>docker-ce_18.06.1\~ce\~3-0\~ubuntu_amd64.deb</code></li><li>上传到上述文件到待安装服务器<code>master</code></li><li>登录待安装服务器，切换到root账户</li><li><code>dpkg -i docker-ce_18.06.1\~ce\~3-0\~ubuntu_amd64.deb</code></li></ol><blockquote><p>如果提示错误</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dpkg: error: dpkg frontend is locked by another process</span><br></pre></td></tr></table></figure><p>说明已经有其他进程在使用dpkg安装程序</p><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">sudo rm /var/<span class="class"><span class="keyword">lib</span>/<span class="title">dpkg</span>/<span class="title">lock</span></span></span><br></pre></td></tr></table></figure><blockquote><p>如果提示错误</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">itcast@master:~/package$ sudo dpkg -i docker-ce_18.06.1~ce~3-0~ubuntu_amd64.deb</span><br><span class="line"> </span><br><span class="line">[sudo] password <span class="keyword">for</span> itcast: </span><br><span class="line">Selecting previously unselected package docker-ce.</span><br><span class="line">(Reading database ... 100647 files and directories currently installed.)</span><br><span class="line">Preparing to unpack docker-ce_18.06.1~ce~3-0~ubuntu_amd64.deb ...</span><br><span class="line">Unpacking docker-ce (18.06.1~ce~3-0~ubuntu) ...</span><br><span class="line">dpkg: dependency problems prevent configuration of docker-ce:</span><br><span class="line"> docker-ce depends on libltdl7 (&gt;= 2.4.6); however:</span><br><span class="line">  Package libltdl7 is not installed.</span><br><span class="line"></span><br><span class="line">dpkg: error processing package docker-ce (--install):</span><br><span class="line"> dependency problems - leaving unconfigured</span><br><span class="line">Processing triggers <span class="keyword">for</span> man-db (2.8.4-2) ...</span><br><span class="line">Processing triggers <span class="keyword">for</span> systemd (239-7ubuntu10) ...</span><br><span class="line">Errors were encountered <span class="keyword">while</span> processing:</span><br><span class="line"> docker-ce</span><br></pre></td></tr></table></figure><p>表示当前docker-ce 依赖系统libltd17库，安装就可以了</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ apt-get install -y libltdl7</span><br></pre></td></tr></table></figure><ol start="5"><li>docker version</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Client:</span><br><span class="line"> Version:           18.06.1-ce</span><br><span class="line"> API version:       1.38</span><br><span class="line"> Go version:        go1.10.3</span><br><span class="line"> Git commit:        e68fc7a</span><br><span class="line"> Built:             Tue Aug 21 17:24:56 2018</span><br><span class="line"> OS/Arch:           linux/amd64</span><br><span class="line"> Experimental:      false</span><br><span class="line"></span><br><span class="line">Server:</span><br><span class="line"> Engine:</span><br><span class="line">  Version:          18.06.1-ce</span><br><span class="line">  API version:      1.38 (minimum version 1.12)</span><br><span class="line">  Go version:       go1.10.3</span><br><span class="line">  Git commit:       e68fc7a</span><br><span class="line">  Built:            Tue Aug 21 17:23:21 2018</span><br><span class="line">  OS/Arch:          linux/amd64</span><br><span class="line">  Experimental:     false</span><br></pre></td></tr></table></figure><p>确保版本号是 <code>18.06</code></p><h2 id="3-3-启动Docker-ce">3.3 启动Docker-ce</h2><ol><li>开机并启动docker</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl enable docker </span><br><span class="line">sudo systemctl start docker</span><br></pre></td></tr></table></figure><ol start="2"><li>重启，登录确认<code>docker</code>已经运行</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">itcast@ubuntu:~$ sudo docker ps </span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</span><br></pre></td></tr></table></figure><ol start="3"><li><p>下载<code>Alpine</code>镜像热身一下 <code>Docker</code></p><p>如果下载很慢，先配置阿里云docker加速</p></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo docker run -it --rm alpine:latest sh</span><br></pre></td></tr></table></figure><p>输出内容如下，我们在 <code>Docker</code> 容器中测试三个命令，分别是</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">* `date`</span><br><span class="line">* `time`</span><br><span class="line">* `uname -r`</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">itcast@ubuntu:~$ sudo docker run -it --rm alpine:latest sh </span><br><span class="line">Unable to find image <span class="string">'alpine:latest'</span> locally</span><br><span class="line">latest: Pulling from library/alpine</span><br><span class="line">e7c96db7181b: Pull complete </span><br><span class="line">Digest: sha256:769fddc7cc2f0a1c35abb2f91432e8beecf83916c421420e6a6da9f8975464b6</span><br><span class="line">Status: Downloaded newer image <span class="keyword">for</span> alpine:latest</span><br><span class="line">/ <span class="comment"># date</span></span><br><span class="line">Mon Jun 10 07:56:01 UTC 2019</span><br><span class="line">/ <span class="comment"># time</span></span><br><span class="line">BusyBox v1.29.3 (2019-01-24 07:45:07 UTC) multi-call binary.</span><br><span class="line"></span><br><span class="line">Usage: time [-vpa] [-o FILE] PROG ARGS</span><br><span class="line"></span><br><span class="line">Run PROG, display resource usage when it exits</span><br><span class="line"></span><br><span class="line">	-v	Verbose</span><br><span class="line">	-p	POSIX output format</span><br><span class="line">	-f FMT	Custom format</span><br><span class="line">	-o FILE	Write result to FILE</span><br><span class="line">	-a	Append (<span class="keyword">else</span> overwrite)</span><br><span class="line">/ <span class="comment"># uname -r </span></span><br><span class="line">4.18.0-10-generic</span><br></pre></td></tr></table></figure><h2 id="3-4-创建Docker用户组并添加当前用户">3.4 创建Docker用户组并添加当前用户</h2><p>使用您的用户登录Linux然后执行如下操作，用户组docker可能已经存在。</p><p>如果使用普通用户目前是无法使用docker指令的</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">itcast@master:~$ docker ps</span><br><span class="line">Got permission denied <span class="keyword">while</span> trying to connect to the Docker daemon socket at unix:///var/run/docker.sock: Get http://%2Fvar%2Frun%2Fdocker.sock/v1.38/containers/json: dial unix /var/run/docker.sock: connect: permission denied</span><br></pre></td></tr></table></figure><p>我们需要将当前的普通用户添加到当前的docker用户组中</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo groupadd docker</span><br><span class="line">sudo usermod -aG docker $USER</span><br><span class="line">exit # 重连服务器</span><br></pre></td></tr></table></figure><p>重新登录使用普通用户登录:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">itcast@master:~$ docker ps</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</span><br></pre></td></tr></table></figure><h2 id="3-5-申请阿里云镜像加速器">3.5 申请阿里云镜像加速器</h2><p>如果不申请阿里云私人专属镜像加速器，鼓励复制如下本人申请的私人专属镜像加速器，直接使用即可。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://ozcouv1b.mirror.aliyuncs.com</span><br></pre></td></tr></table></figure><p><strong>申请步骤如下</strong></p><p>在阿里云注册自己账户</p><p>找到<strong>容器镜像服务</strong>，参考网址如下</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://cr.console.aliyun.com/cn-hangzhou/instances/mirrors</span><br></pre></td></tr></table></figure><p>点开左侧菜单<strong>镜像中心</strong>—&gt;<strong>镜像加速器</strong></p><p>右侧加速器地址，即使私人专属的镜像加速器地址，点击<strong>复制</strong></p><p>粘贴到一个文本文件留存</p><hr><h2 id="3-6-docker配置国内镜像加速器">3.6 docker配置国内镜像加速器</h2><blockquote><p>目的 : 为了下载docker镜像更快</p></blockquote><p>您可以通过修改 <code>daemon</code> 配置文件 <code>/etc/docker/daemon.json</code> 来使用加速器。</p><p>创建 <code>/etc/docker/daemon.json</code> 文件，内容如下：</p><p>自己的：<a href="https://6hqau5r2.mirror.aliyuncs.com" target="_blank" rel="noopener">https://6hqau5r2.mirror.aliyuncs.com</a></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"registry-mirrors"</span>: [<span class="string">"https://6hqau5r2.mirror.aliyuncs.com"</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 安装harbor时，客户端需要加上insecure-registries，（添加非信任授权）地址为harbor仓库的地址</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"insecure-registries"</span>: [<span class="string">"111.229.16.185"</span>],</span><br><span class="line">  <span class="attr">"registry-mirrors"</span>: [<span class="string">"https://ozcouv1b.mirror.aliyuncs.com"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>重启docker服务</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 重载所有修改过的配置文件</span></span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line"><span class="meta">#</span><span class="bash"> 重启Docker服务</span></span><br><span class="line">sudo systemctl restart docker</span><br><span class="line"><span class="meta">#</span><span class="bash"> 或者</span></span><br><span class="line">systemctl daemon-reload&amp;&amp;systemctl restart docker</span><br></pre></td></tr></table></figure><h1>四、Kubernetes 安装及部署</h1><h2 id="4-1-k8s安装环境准备">4.1 k8s安装环境准备</h2><h3 id="4-1-1-配置并安装k8s国内源">4.1.1 配置并安装k8s国内源</h3><ol><li><p>创建配置文件<code>sudo touch /etc/apt/sources.list.d/kubernetes.list</code></p></li><li><p>添加写权限</p></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">itcast@master:~$ sudo chmod 666 /etc/apt/sources.list.d/kubernetes.list</span><br></pre></td></tr></table></figure><p>再添加，内容如下:</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">deb http:<span class="regexp">//mi</span>rrors.ustc.edu.cn<span class="regexp">/kubernetes/</span>apt kubernetes-xenial main</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 上面出现502网关错误，换成阿里的。如果出现代理错误，去掉https 改成http</span></span><br><span class="line">deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main</span><br></pre></td></tr></table></figure><ol start="3"><li>执行<code>sudo apt update</code> 更新操作系统源，开始会遇见如下错误</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">tcast@master:~$ sudo apt update</span><br><span class="line">   Get:1 http://mirrors.ustc.edu.cn/kubernetes/apt kubernetes-xenial InRelease [8,993 B]</span><br><span class="line">   Err:1 http://mirrors.ustc.edu.cn/kubernetes/apt kubernetes-xenial InRelease    </span><br><span class="line">     The following signatures couldn<span class="string">'t be verified because the public key is not available: NO_PUBKEY 6A030B21BA07F4FB</span></span><br><span class="line"><span class="string">   Hit:2 http://mirrors.aliyun.com/ubuntu cosmic InRelease                        </span></span><br><span class="line"><span class="string">   Hit:3 http://mirrors.aliyun.com/ubuntu cosmic-updates InRelease                </span></span><br><span class="line"><span class="string">   Hit:4 http://mirrors.aliyun.com/ubuntu cosmic-backports InRelease              </span></span><br><span class="line"><span class="string">   Hit:5 http://mirrors.aliyun.com/ubuntu cosmic-security InRelease               </span></span><br><span class="line"><span class="string">   Err:6 https://mirrors.ustc.edu.cn/docker-ce/linux/ubuntu cosmic InRelease      </span></span><br><span class="line"><span class="string">     Could not wait for server fd - select (11: Resource temporarily unavailable) [IP: 202.141.176.110 443]</span></span><br><span class="line"><span class="string">   Reading package lists... Done                          </span></span><br><span class="line"><span class="string">   W: GPG error: http://mirrors.ustc.edu.cn/kubernetes/apt kubernetes-xenial InRelease: The following signatures couldn'</span>t be verified because the public key is not available: NO_PUBKEY 6A030B21BA07F4FB</span><br><span class="line">   E: The repository <span class="string">'http://mirrors.ustc.edu.cn/kubernetes/apt kubernetes-xenial InRelease'</span> is not signed.</span><br><span class="line">   N: Updating from such a repository can<span class="string">'t be done securely, and is therefore disabled by default.</span></span><br><span class="line"><span class="string">   N: See apt-secure(8) manpage for repository creation and user configuration details.</span></span><br></pre></td></tr></table></figure><p>其中：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The following signatures couldn<span class="string">'t be verified because the public key is not available: NO_PUBKEY 6A030B21BA07F4FB</span></span><br></pre></td></tr></table></figure><p>签名认证失败，需要重新生成。记住上面的<em>NO_PUBKEY</em> <code>6A030B21BA07F4FB</code></p><ol start="4"><li><p>添加认证key</p><p>运行如下命令，添加错误中对应的key(错误中NO_PUBKEY后面的key的后8位)</p></li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gpg --keyserver keyserver.ubuntu.com --recv-keys BA07F4FB</span><br></pre></td></tr></table></figure><p>接着运行如下命令，确认看到<strong>OK</strong>，说明成功，之后进行安装:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gpg --export --armor BA07F4FB | sudo apt-key add -</span><br></pre></td></tr></table></figure><ol start="5"><li>再次重新<code>sudo apt update</code>更新系统下载源数据列表</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">itcast@master:~$ sudo apt update</span><br><span class="line">Hit:1 https://mirrors.ustc.edu.cn/docker-ce/linux/ubuntu cosmic InRelease                  </span><br><span class="line">Hit:2 http://mirrors.aliyun.com/ubuntu cosmic InRelease                                    </span><br><span class="line">Hit:3 http://mirrors.aliyun.com/ubuntu cosmic-updates InRelease                            </span><br><span class="line">Hit:4 http://mirrors.aliyun.com/ubuntu cosmic-backports InRelease                          </span><br><span class="line">Hit:5 http://mirrors.aliyun.com/ubuntu cosmic-security InRelease                           </span><br><span class="line">Get:6 http://mirrors.ustc.edu.cn/kubernetes/apt kubernetes-xenial InRelease [8,993 B]      </span><br><span class="line">Ign:7 http://mirrors.ustc.edu.cn/kubernetes/apt kubernetes-xenial/main amd64 Packages</span><br><span class="line">Get:7 http://mirrors.ustc.edu.cn/kubernetes/apt kubernetes-xenial/main amd64 Packages [26.6 kB]</span><br><span class="line">Fetched 26.6 kB <span class="keyword">in</span> 42s (635 B/s)    </span><br><span class="line">Reading package lists... Done</span><br><span class="line">Building dependency tree       </span><br><span class="line">Reading state information... Done</span><br><span class="line">165 packages can be upgraded. Run <span class="string">'apt list --upgradable'</span> to see them.</span><br></pre></td></tr></table></figure><p>以上没有报和错误异常，表示成功。</p><h3 id="4-1-2-禁止基础设施">4.1.2 禁止基础设施</h3><ol><li>禁止防火墙</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo ufw <span class="built_in">disable</span> （Uncomplicated FireWall）</span></span><br><span class="line">Firewall stopped and disabled on system startup</span><br></pre></td></tr></table></figure><ol start="2"><li>关闭swap</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 成功</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo swapoff -a </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 永久关闭swap分区</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo sed -i <span class="string">'s/.*swap.*/#&amp;/'</span> /etc/fstab</span></span><br></pre></td></tr></table></figure><ol start="3"><li>禁止selinux</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 安装操控selinux的命令</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo apt install -y selinux-utils</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 禁止selinux</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> setenforce 0</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 重启操作系统</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> shutdown -r now</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看selinux是否已经关闭</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo getenforce</span></span><br><span class="line">Disabled(表示已经关闭)</span><br></pre></td></tr></table></figure><h2 id="4-2-k8s系统网络配置">4.2 k8s系统网络配置</h2><p>(1) 配置内核参数，将桥接的IPv4流量传递到iptables的链</p><p>创建 <code>/etc/sysctl.d/k8s.conf</code> 文件</p><p>添加内容如下:</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">net.bridge.bridge-nf-call-ip6tables</span> = <span class="number">1</span></span><br><span class="line"><span class="attr">net.bridge.bridge-nf-call-iptables</span> = <span class="number">1</span></span><br><span class="line"><span class="attr">vm.swappiness</span> = <span class="number">0</span></span><br></pre></td></tr></table></figure><p>(2) 执行命令使修改生效</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 【候选】建议执行下面的命令</span></span><br><span class="line">$ sudo modprobe br_netfilter</span><br><span class="line">$ sudo sysctl -p /etc/sysctl.d/k8s.conf</span><br></pre></td></tr></table></figure><h2 id="4-3-安装k8s">4.3 安装k8s</h2><blockquote><p>**注意: 切换到root用户 <code>$ su</code> **</p></blockquote><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">master<span class="variable">@master</span><span class="symbol">:~</span><span class="variable">$ </span>su</span><br><span class="line"><span class="symbol">Password:</span> </span><br><span class="line"><span class="symbol">su:</span> Authentication failure</span><br><span class="line"><span class="comment"># 如果出现以上错误，什么被lock了，重置下root密码：</span></span><br><span class="line">sudo passwd</span><br></pre></td></tr></table></figure><p>切换后变成root账户了</p><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">root<span class="variable">@master</span><span class="symbol">:/home/master</span><span class="comment">#</span></span><br></pre></td></tr></table></figure><ol><li>安装Kubernetes 目前安装版本 <code>v1.13.1</code></li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> apt update &amp;&amp; apt-get install -y kubelet=1.13.1-00 kubernetes-cni=0.6.0-00 kubeadm=1.13.1-00 kubectl=1.13.1-00</span></span><br></pre></td></tr></table></figure><ol start="2"><li>设置为开机重启</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo systemctl <span class="built_in">enable</span> kubelet &amp;&amp; systemctl start kubelet</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo shutdown -r now</span></span><br></pre></td></tr></table></figure><h2 id="4-4-验证k8s">4.4 验证k8s</h2><ol><li><p>使用root用户登录<code>Master</code>主机</p></li><li><p>执行如下个命令</p></li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get nodes</span><br></pre></td></tr></table></figure><p>输出如下</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl get nodes</span></span><br><span class="line">The connection to the server localhost:8080 was refused - did you specify the right host or port?</span><br></pre></td></tr></table></figure><ol start="3"><li>查看当前k8s版本</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl version</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Client Version: version.Info&#123;Major:<span class="string">"1"</span>, Minor:<span class="string">"13"</span>, GitVersion:<span class="string">"v1.13.1"</span>, GitCommit:<span class="string">"eec55b9ba98609a46fee712359c7b5b365bdd920"</span>, GitTreeState:<span class="string">"clean"</span>, BuildDate:<span class="string">"2018-12-13T10:39:04Z"</span>, GoVersion:<span class="string">"go1.11.2"</span>, Compiler:<span class="string">"gc"</span>, Platform:<span class="string">"linux/amd64"</span>&#125;</span><br><span class="line">The connection to the server localhost:8080 was refused - did you specify the right host or port?</span><br></pre></td></tr></table></figure><h1>五、创建企业Kubernetes多主机集群环境</h1><h2 id="5-1-创建两个节点-两个虚拟机">5.1 创建两个节点(两个虚拟机)</h2><ol><li>在VMWare中创建完整克隆，分别命名为<code>UbuntuNode1</code>和<code>UbuntuNode2</code></li></ol><p>分别对两个完整克隆的虚拟机进行如下操作，修改主机名称和静态IP</p><ol><li><p>使用root用户登录</p></li><li><p>打开配置文件<code>vim /etc/cloud/cloud.cfg</code></p></li><li><p>修改配置<code>preserve_hostname: true</code></p></li><li><p>修改<code>/etc/hostname</code>，只有一行 <code>node1</code>或<code>node2</code></p></li></ol><h2 id="5-2-master和node基础配置">5.2 master和node基础配置</h2><h3 id="5-2-1-给node配置hostname">5.2.1 给node配置hostname</h3><p><code>node1</code> 主机</p><p>/etc/hostname</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node1</span><br></pre></td></tr></table></figure><p><code>node2</code> 主机</p><p>/et/hostname</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node2</span><br></pre></td></tr></table></figure><ol start="2"><li>确认配置的三台机器的主机名称</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat /etc/hosts</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> shutdown -r now</span></span><br></pre></td></tr></table></figure><h3 id="5-2-2-配置IP地址">5.2.2 配置IP地址</h3><ul><li>master</li></ul><p><code>/etc/netplan/50-cloud-init.yaml</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">network:</span><br><span class="line">    ethernets:</span><br><span class="line">        ens33:</span><br><span class="line">            addresses: [192.168.236.177/24]</span><br><span class="line">            dhcp4: <span class="literal">false</span></span><br><span class="line">            gateway4: 192.168.236.2</span><br><span class="line">            nameservers:</span><br><span class="line">                       addresses: [192.168.236.2]</span><br><span class="line">            optional: <span class="literal">true</span></span><br><span class="line">    version: 2</span><br></pre></td></tr></table></figure><p>重启ip配置</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netplan apply</span><br></pre></td></tr></table></figure><ul><li>node1</li></ul><p><code>/etc/netplan/50-cloud-init.yaml</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">network:</span><br><span class="line">    ethernets:</span><br><span class="line">        ens33:</span><br><span class="line">            addresses: [192.168.236.178/24]</span><br><span class="line">            dhcp4: <span class="literal">false</span></span><br><span class="line">            gateway4: 192.168.236.2</span><br><span class="line">            nameservers:</span><br><span class="line">                       addresses: [192.168.236.2]</span><br><span class="line">            optional: <span class="literal">true</span></span><br><span class="line">    version: 2</span><br></pre></td></tr></table></figure><p>重启ip配置</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netplan apply</span><br></pre></td></tr></table></figure><ul><li>node2</li></ul><p><code>/etc/netplan/50-cloud-init.yaml</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">network:</span><br><span class="line">    ethernets:</span><br><span class="line">        ens33:</span><br><span class="line">            addresses: [192.168.236.179/24]</span><br><span class="line">            dhcp4: <span class="literal">false</span></span><br><span class="line">            gateway4: 192.168.236.2</span><br><span class="line">            nameservers:</span><br><span class="line">                       addresses: [192.168.236.2]</span><br><span class="line">            optional: <span class="literal">true</span></span><br><span class="line">    version: 2</span><br></pre></td></tr></table></figure><p>重启ip配置</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netplan apply</span><br></pre></td></tr></table></figure><h3 id="5-2-3-修改hosts文件">5.2.3 修改hosts文件</h3><p>注意： (Master、Node1、Node2都需要配置)</p><p>使用root用户登录</p><ol><li><p>打开hosts文件 <code>vim /etc/hosts</code></p></li><li><p>输入如下内容</p></li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">192.168.236.177 master</span><br><span class="line">192.168.236.178 node1</span><br><span class="line">192.168.236.179 node2</span><br></pre></td></tr></table></figure><ol start="3"><li>重启机器<code>shutdown -r now</code></li></ol><h2 id="5-3-配置Master节点">5.3 配置Master节点</h2><h3 id="5-3-1-创建工作目录">5.3.1 创建工作目录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mkdir /home/itcast/working</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> /home/itcast/working/</span></span><br></pre></td></tr></table></figure><h3 id="5-3-2-创建kubeadm-conf配置文件">5.3.2 创建kubeadm.conf配置文件</h3><ol><li>创建k8s的管理工具<code>kubeadm</code>对应的配置文件，候选操作在<code>home/itcast/working/</code>目录下</li></ol><p>使用kubeadm配置文件，通过在配置文件中指定docker仓库地址，便于内网快速部署。</p><p>生成配置文件</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">kubeadm<span class="built_in"> config </span><span class="builtin-name">print</span> init-defaults ClusterConfiguration &gt; kubeadm.conf</span><br></pre></td></tr></table></figure><ol start="2"><li>修改<code>kubeadm.conf</code>中的如下两项:</li></ol><ul><li>imageRepository</li><li>kubernetesVersion</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vi kubeadm.conf</span><br><span class="line"><span class="comment"># 修改 imageRepository: k8s.gcr.io</span></span><br><span class="line"><span class="comment"># 改为 registry.cn-beijing.aliyuncs.com/imcto</span></span><br><span class="line">imageRepository: registry.cn-beijing.aliyuncs.com/imcto</span><br><span class="line"><span class="comment"># 修改kubernetes版本kubernetesVersion: v1.13.0</span></span><br><span class="line"><span class="comment"># 改为kubernetesVersion: v1.13.1</span></span><br><span class="line">kubernetesVersion: v1.13.1</span><br></pre></td></tr></table></figure><ol start="3"><li>修改<code>kubeadm.conf</code>中的API服务器地址，后面会频繁使用这个地址。</li></ol><ul><li>localAPIEndpoint:</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">localAPIEndpoint:</span><br><span class="line">  advertiseAddress: 192.168.236.177</span><br><span class="line">  bindPort: 6443</span><br></pre></td></tr></table></figure><blockquote><p>注意: <code>192.168.236.177</code> 是master主机的ip地址</p></blockquote><ol start="4"><li>配置子网网络</li></ol><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">networking:</span><br><span class="line">  dnsDomain: cluster.local</span><br><span class="line">  podSubnet: 10.244.0.0/16</span><br><span class="line">  serviceSubnet: 10.96.0.0/12</span><br><span class="line">scheduler: &#123;&#125;</span><br></pre></td></tr></table></figure><p>这里的 <code>10.244.0.0/16</code> 和 <code>10.96.0.0/12</code> 分别是k8s内部pods和services的子网网络，最好使用这个地址，后续flannel网络需要用到。</p><h3 id="5-3-3-拉取K8s必备的模块镜像">5.3.3 拉取K8s必备的模块镜像</h3><ol><li>查看一下都需要哪些镜像文件需要拉取</li></ol><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">$ kubeadm config images <span class="keyword">list</span> --config kubeadm.<span class="keyword">conf</span></span><br><span class="line">registry.<span class="keyword">cn</span>-beijing.aliyuncs.<span class="keyword">com</span>/imcto/kube-apiserver:v1.<span class="number">13.1</span></span><br><span class="line">registry.<span class="keyword">cn</span>-beijing.aliyuncs.<span class="keyword">com</span>/imcto/kube-controller-manager:v1.<span class="number">13.1</span></span><br><span class="line">registry.<span class="keyword">cn</span>-beijing.aliyuncs.<span class="keyword">com</span>/imcto/kube-scheduler:v1.<span class="number">13.1</span></span><br><span class="line">registry.<span class="keyword">cn</span>-beijing.aliyuncs.<span class="keyword">com</span>/imcto/kube-proxy:v1.<span class="number">13.1</span></span><br><span class="line">registry.<span class="keyword">cn</span>-beijing.aliyuncs.<span class="keyword">com</span>/imcto/pause:<span class="number">3.1</span></span><br><span class="line">registry.<span class="keyword">cn</span>-beijing.aliyuncs.<span class="keyword">com</span>/imcto/etcd:<span class="number">3.2</span>.<span class="number">24</span></span><br><span class="line">registry.<span class="keyword">cn</span>-beijing.aliyuncs.<span class="keyword">com</span>/imcto/coredn<span class="variable">s:1</span>.<span class="number">2.6</span></span><br></pre></td></tr></table></figure><ol start="2"><li>拉取镜像</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#下载全部当前版本的k8s所关联的镜像</span></span><br><span class="line">kubeadm config images pull --config ./kubeadm.conf</span><br></pre></td></tr></table></figure><h3 id="5-3-4-初始化kubernetes环境">5.3.4 初始化kubernetes环境</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#初始化并且启动</span></span><br><span class="line">$ sudo kubeadm init --config ./kubeadm.conf</span><br></pre></td></tr></table></figure><p><strong>cpu需要配高一点</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">master@master:~/yangbo/working$ sudo kubeadm init --config ./kubeadm.conf </span><br><span class="line">[init] Using Kubernetes version: v1.13.1</span><br><span class="line">[preflight] Running pre-flight checks</span><br><span class="line">error execution phase preflight: [preflight] Some fatal errors occurred:</span><br><span class="line">        [ERROR NumCPU]: the number of available CPUs 1 is less than the required 2</span><br><span class="line">[preflight] If you know what you are doing, you can make a check non-fatal with `--ignore-preflight-errors=...`</span><br></pre></td></tr></table></figure><p>更多kubeadm配置文件参数详见</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">kubeadm<span class="built_in"> config </span>print-defaults</span><br></pre></td></tr></table></figure><p><strong>k8s启动成功输出内容较多，但是记住末尾的内容 ，或者后面重新生成token</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Your Kubernetes master has initialized successfully!</span><br><span class="line"></span><br><span class="line">To start using your cluster, you need to run the following as a regular user:</span><br><span class="line"></span><br><span class="line">  mkdir -p $HOME/.kube</span><br><span class="line">  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">  sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br><span class="line"></span><br><span class="line">You should now deploy a pod network to the cluster.</span><br><span class="line">Run "kubectl apply -f [podnetwork].yaml" with one of the options listed at:</span><br><span class="line">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class="line"></span><br><span class="line">You can now join any number of machines by running the following on each node</span><br><span class="line">as root:</span><br><span class="line"></span><br><span class="line">  kubeadm join 192.168.236.177:6443 --token abcdef.0123456789abcdef --discovery-token-ca-cert-hash sha256:e778d3665e52f5a680a87b00c6d54df726c2eda601c0db3bfa4bb198af2262a8</span><br></pre></td></tr></table></figure><p>按照官方提示，执行以下操作。</p><ol><li>执行如下命令</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mkdir -p <span class="variable">$HOME</span>/.kube</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo cp -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo chown $(id -u):$(id -g) <span class="variable">$HOME</span>/.kube/config</span></span><br></pre></td></tr></table></figure><ol start="2"><li>创建系统服务并启动</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 启动kubelet 设置为开机自启动</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo systemctl <span class="built_in">enable</span> kubelet</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动k8s服务程序</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo systemctl start kubelet</span></span><br></pre></td></tr></table></figure><h3 id="5-3-5-验证kubernetes启动结果">5.3.5 验证kubernetes启动结果</h3><ol><li>验证输入，注意显示master状态是<code>NotReady</code>，证明初始化服务器成功</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl get nodes</span></span><br><span class="line">NAME     STATUS     ROLES    AGE   VERSION</span><br><span class="line">master   NotReady   master   12m   v1.13.1</span><br></pre></td></tr></table></figure><ol start="2"><li>查看当前k8s集群状态</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl get cs</span></span><br><span class="line">NAME                 STATUS    MESSAGE              ERROR</span><br><span class="line">scheduler            Healthy   ok</span><br><span class="line">controller-manager   Healthy   ok</span><br><span class="line">etcd-0               Healthy   &#123;"health": "true"&#125;</span><br></pre></td></tr></table></figure><p>目前只有一个master，还没有node，而且是NotReady状态，那么我们需要将node加入到master管理的集群中来。在加入之前，我们需要先配置k8s集群的内部通信网络，这里采用的是flannel网络。</p><h3 id="5-3-6-部署集群内部通信flannel网络">5.3.6 部署集群内部通信flannel网络</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$cd</span> <span class="variable">$HOME</span>/working</span><br><span class="line"><span class="variable">$wget</span> https://raw.githubusercontent.com/coreos/flannel/a70459be0084506e4ec919aa1c114638878db11b/Documentation/kube-flannel.yml</span><br></pre></td></tr></table></figure><p>这个网站在国外，如果无法访问，翻墙或者配值可以访问的ip</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">151.101.76.133 raw.githubusercontent.com</span><br></pre></td></tr></table></figure><p><a href="https://blog.csdn.net/weixin_40973138/article/details/106081946?utm_medium=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-2.channel_param&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-2.channel_param" target="_blank" rel="noopener">教程</a></p><p>编辑这个文件，确保flannel网络是对的, 找到 <code>net-conf.json</code> 标记的内容是否正确。</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">net-conf.json: |</span><br><span class="line">   &#123;</span><br><span class="line">     "Network": "10.244.0.0/16",</span><br><span class="line">     "Backend": &#123;</span><br><span class="line">       "Type": "vxlan"</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure><p><strong>这个&quot;10.244.0.0/16&quot;和 ./kubeadm.conf中的podsubnet的地址要一致。</strong></p><p>应用当前flannel配置文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">itcast@master:~/working$ kubectl apply -f kube-flannel.yml</span><br></pre></td></tr></table></figure><p>输出结果如下</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@master:~/working# kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/a70459be0084506e4ec919aa1c114638878db11b/Documentation/kube-flannel.yml</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/flannel created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/flannel created</span><br><span class="line">serviceaccount/flannel created</span><br><span class="line">configmap/kube-flannel-cfg created</span><br><span class="line">daemonset.extensions/kube-flannel-ds-amd64 created</span><br><span class="line">daemonset.extensions/kube-flannel-ds-arm64 created</span><br><span class="line">daemonset.extensions/kube-flannel-ds-arm created</span><br><span class="line">daemonset.extensions/kube-flannel-ds-ppc64le created</span><br><span class="line">daemonset.extensions/kube-flannel-ds-s390x created</span><br></pre></td></tr></table></figure><p>安装flannel网络前 执行 <code>kubectl get nodes</code> 输出结果如下</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">itcast@master:~/working$ kubectl get node</span><br><span class="line">NAME     STATUS     ROLES    AGE   VERSION</span><br><span class="line">master   NotReady   master   10m   v1.13.1</span><br></pre></td></tr></table></figure><p>安装flannel网络后 执行 <code>kubectl get nodes</code> 输出结果如下</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">itcast@master:~/working$ kubectl get node</span><br><span class="line">NAME     STATUS   ROLES    AGE   VERSION</span><br><span class="line">master   Ready    master   10m   v1.13.1</span><br></pre></td></tr></table></figure><p>此时master已经是 <code>Ready</code> 状态了，表示已经配置成功了，那么我们就需要配置node来加入这个集群</p><p>如果没有成功，看日志</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod,cs -n kube-system # 启动的pod cs集群信息 </span><br><span class="line">journalctl -f -u kubelet # 日志</span><br></pre></td></tr></table></figure><p><a href="https://blog.csdn.net/hehj369986957/article/details/107856603" target="_blank" rel="noopener">https://blog.csdn.net/hehj369986957/article/details/107856603</a></p><p>构建flannel 时，需要下载一些docker，因为被强了，所以有些不能下载，可以通过</p><p><code>journalctl -f -u kubelet</code> 查看 日志</p><p>比如 <a href="http://quay.io/coreos/flannel:v0.11.0-amd64" target="_blank" rel="noopener">quay.io/coreos/flannel:v0.11.0-amd64</a> 某个版本 下不下来，可以去github官网下载</p><p><a href="https://github.com/coreos/flannel/releases" target="_blank" rel="noopener">官网</a>，迅雷下快一点</p><p>然后finalshell上传, 本地安装</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker load &lt; flanneld-v0.11.0-amd64.docker</span><br></pre></td></tr></table></figure><p>如果下载不下来，自己用这个yml，注意版本：是0.11的</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">flannel</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"></span><br><span class="line">  <span class="string">+</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">""</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="string">+</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">""</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nodes</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="string">+</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">""</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nodes/status</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="string">patch</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">flannel</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">flannel</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"></span><br><span class="line"><span class="string">*</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">name:</span> <span class="string">flannel</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">flannel</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kube-flannel-cfg</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">node</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">flannel</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">cni-conf.json:</span> <span class="string">|</span></span><br><span class="line">    <span class="string">&#123;</span></span><br><span class="line">      <span class="attr">"name":</span> <span class="string">"cbr0"</span><span class="string">,</span></span><br><span class="line">      <span class="attr">"plugins":</span> <span class="string">[</span></span><br><span class="line">        <span class="string">&#123;</span></span><br><span class="line">          <span class="attr">"type":</span> <span class="string">"flannel"</span><span class="string">,</span></span><br><span class="line">          <span class="attr">"delegate":</span> <span class="string">&#123;</span></span><br><span class="line">            <span class="attr">"hairpinMode":</span> <span class="literal">true</span><span class="string">,</span></span><br><span class="line">            <span class="attr">"isDefaultGateway":</span> <span class="literal">true</span></span><br><span class="line">          <span class="string">&#125;</span></span><br><span class="line">        <span class="string">&#125;,</span></span><br><span class="line">        <span class="string">&#123;</span></span><br><span class="line">          <span class="attr">"type":</span> <span class="string">"portmap"</span><span class="string">,</span></span><br><span class="line">          <span class="attr">"capabilities":</span> <span class="string">&#123;</span></span><br><span class="line">            <span class="attr">"portMappings":</span> <span class="literal">true</span></span><br><span class="line">          <span class="string">&#125;</span></span><br><span class="line">        <span class="string">&#125;</span></span><br><span class="line">      <span class="string">]</span></span><br><span class="line">    <span class="string">&#125;</span></span><br><span class="line">  <span class="attr">net-conf.json:</span> <span class="string">|</span></span><br><span class="line">    <span class="string">&#123;</span></span><br><span class="line">      <span class="attr">"Network":</span> <span class="string">"10.244.0.0/16"</span><span class="string">,</span></span><br><span class="line">      <span class="attr">"Backend":</span> <span class="string">&#123;</span></span><br><span class="line">        <span class="attr">"Type":</span> <span class="string">"vxlan"</span></span><br><span class="line">      <span class="string">&#125;</span></span><br><span class="line">    <span class="string">&#125;</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kube-flannel-ds-amd64</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">node</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">flannel</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">tier:</span> <span class="string">node</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">flannel</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">hostNetwork:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">nodeSelector:</span></span><br><span class="line">        <span class="attr">beta.kubernetes.io/arch:</span> <span class="string">amd64</span></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">flannel</span></span><br><span class="line">      <span class="attr">initContainers:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install-cni</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">image:</span> <span class="string">quay.io/coreos/flannel:v0.11.0-amd64</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="string">cp</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">args:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="string">-f</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/etc/kube-flannel/cni-conf.json</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/etc/cni/net.d/10-flannel.conflist</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cni</span></span><br><span class="line"></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/cni/net.d</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">flannel-cfg</span></span><br><span class="line"></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/kube-flannel/</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kube-flannel</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">image:</span> <span class="string">quay.io/coreos/flannel:v0.11.0-amd64</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/opt/bin/flanneld</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">args:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--ip-masq</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--kube-subnet-mgr</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">"100m"</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">"50Mi"</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">"100m"</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">"50Mi"</span></span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAME</span></span><br><span class="line"></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAMESPACE</span></span><br><span class="line"></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.namespace</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">run</span></span><br><span class="line"></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/run</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">flannel-cfg</span></span><br><span class="line"></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/kube-flannel/</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">run</span></span><br><span class="line"></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/run</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cni</span></span><br><span class="line"></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/etc/cni/net.d</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">flannel-cfg</span></span><br><span class="line"></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">kube-flannel-cfg</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kube-flannel-ds-arm64</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">node</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">flannel</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">tier:</span> <span class="string">node</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">flannel</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">hostNetwork:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">nodeSelector:</span></span><br><span class="line">        <span class="attr">beta.kubernetes.io/arch:</span> <span class="string">arm64</span></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">flannel</span></span><br><span class="line">      <span class="attr">initContainers:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install-cni</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">image:</span> <span class="string">quay.io/coreos/flannel:v0.11.0-arm64</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="string">cp</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">args:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="string">-f</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/etc/kube-flannel/cni-conf.json</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/etc/cni/net.d/10-flannel.conflist</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cni</span></span><br><span class="line"></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/cni/net.d</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">flannel-cfg</span></span><br><span class="line"></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/kube-flannel/</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kube-flannel</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">image:</span> <span class="string">quay.io/coreos/flannel:v0.11.0-arm64</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/opt/bin/flanneld</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">args:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--ip-masq</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--kube-subnet-mgr</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">"100m"</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">"50Mi"</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">"100m"</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">"50Mi"</span></span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAME</span></span><br><span class="line"></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAMESPACE</span></span><br><span class="line"></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.namespace</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">run</span></span><br><span class="line"></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/run</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">flannel-cfg</span></span><br><span class="line"></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/kube-flannel/</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">run</span></span><br><span class="line"></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/run</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cni</span></span><br><span class="line"></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/etc/cni/net.d</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">flannel-cfg</span></span><br><span class="line"></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">kube-flannel-cfg</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kube-flannel-ds-arm</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">node</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">flannel</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">tier:</span> <span class="string">node</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">flannel</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">hostNetwork:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">nodeSelector:</span></span><br><span class="line">        <span class="attr">beta.kubernetes.io/arch:</span> <span class="string">arm</span></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">flannel</span></span><br><span class="line">      <span class="attr">initContainers:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install-cni</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">image:</span> <span class="string">quay.io/coreos/flannel:v0.11.0-arm</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="string">cp</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">args:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="string">-f</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/etc/kube-flannel/cni-conf.json</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/etc/cni/net.d/10-flannel.conflist</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cni</span></span><br><span class="line"></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/cni/net.d</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">flannel-cfg</span></span><br><span class="line"></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/kube-flannel/</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kube-flannel</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">image:</span> <span class="string">quay.io/coreos/flannel:v0.11.0-arm</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/opt/bin/flanneld</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">args:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--ip-masq</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--kube-subnet-mgr</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">"100m"</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">"50Mi"</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">"100m"</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">"50Mi"</span></span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAME</span></span><br><span class="line"></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAMESPACE</span></span><br><span class="line"></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.namespace</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">run</span></span><br><span class="line"></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/run</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">flannel-cfg</span></span><br><span class="line"></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/kube-flannel/</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">run</span></span><br><span class="line"></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/run</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cni</span></span><br><span class="line"></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/etc/cni/net.d</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">flannel-cfg</span></span><br><span class="line"></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">kube-flannel-cfg</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kube-flannel-ds-ppc64le</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">node</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">flannel</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">tier:</span> <span class="string">node</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">flannel</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">hostNetwork:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">nodeSelector:</span></span><br><span class="line">        <span class="attr">beta.kubernetes.io/arch:</span> <span class="string">ppc64le</span></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">flannel</span></span><br><span class="line">      <span class="attr">initContainers:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install-cni</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">image:</span> <span class="string">quay.io/coreos/flannel:v0.11.0-ppc64le</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="string">cp</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">args:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="string">-f</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/etc/kube-flannel/cni-conf.json</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/etc/cni/net.d/10-flannel.conflist</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cni</span></span><br><span class="line"></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/cni/net.d</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">flannel-cfg</span></span><br><span class="line"></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/kube-flannel/</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kube-flannel</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">image:</span> <span class="string">quay.io/coreos/flannel:v0.11.0-ppc64le</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/opt/bin/flanneld</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">args:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--ip-masq</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--kube-subnet-mgr</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">"100m"</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">"50Mi"</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">"100m"</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">"50Mi"</span></span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAME</span></span><br><span class="line"></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAMESPACE</span></span><br><span class="line"></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.namespace</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">run</span></span><br><span class="line"></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/run</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">flannel-cfg</span></span><br><span class="line"></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/kube-flannel/</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">run</span></span><br><span class="line"></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/run</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cni</span></span><br><span class="line"></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/etc/cni/net.d</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">flannel-cfg</span></span><br><span class="line"></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">kube-flannel-cfg</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kube-flannel-ds-s390x</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">node</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">flannel</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">tier:</span> <span class="string">node</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">flannel</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">hostNetwork:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">nodeSelector:</span></span><br><span class="line">        <span class="attr">beta.kubernetes.io/arch:</span> <span class="string">s390x</span></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">flannel</span></span><br><span class="line">      <span class="attr">initContainers:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install-cni</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">image:</span> <span class="string">quay.io/coreos/flannel:v0.11.0-s390x</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="string">cp</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">args:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="string">-f</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/etc/kube-flannel/cni-conf.json</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/etc/cni/net.d/10-flannel.conflist</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cni</span></span><br><span class="line"></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/cni/net.d</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">flannel-cfg</span></span><br><span class="line"></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/kube-flannel/</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kube-flannel</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">image:</span> <span class="string">quay.io/coreos/flannel:v0.11.0-s390x</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/opt/bin/flanneld</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">args:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--ip-masq</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--kube-subnet-mgr</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">"100m"</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">"50Mi"</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">"100m"</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">"50Mi"</span></span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAME</span></span><br><span class="line"></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAMESPACE</span></span><br><span class="line"></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.namespace</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">run</span></span><br><span class="line"></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/run</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">flannel-cfg</span></span><br><span class="line"></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/kube-flannel/</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">run</span></span><br><span class="line"></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/run</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cni</span></span><br><span class="line"></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/etc/cni/net.d</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">flannel-cfg</span></span><br><span class="line"></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">kube-flannel-cfg</span></span><br></pre></td></tr></table></figure><p>如果报错就只有一个</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Runtime network not ready: NetworkReady=false reason:NetworkPluginNotReady message:docker: network plugin is not ready: cni config uninitialized</span><br></pre></td></tr></table></figure><p>试试重启，可能就会ready了</p><p>效果</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">master@master:~$  kubectl get pod,cs -n kube-system</span><br><span class="line">NAME                                 READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/coredns-59b69b999c-qj7m7         1/1     Running   0          17h</span><br><span class="line">pod/coredns-59b69b999c-sc67w         1/1     Running   0          17h</span><br><span class="line">pod/etcd-master                      1/1     Running   2          18h</span><br><span class="line">pod/kube-apiserver-master            1/1     Running   2          18h</span><br><span class="line">pod/kube-controller-manager-master   1/1     Running   2          18h</span><br><span class="line">pod/kube-flannel-ds-6m9cg            1/1     Running   0          7m37s</span><br><span class="line">pod/kube-flannel-ds-amd64-nx5bp      1/1     Running   0          11h</span><br><span class="line">pod/kube-proxy-7drcn                 1/1     Running   2          18h</span><br><span class="line">pod/kube-scheduler-master            1/1     Running   2          18h</span><br><span class="line"></span><br><span class="line">NAME                                 STATUS    MESSAGE              ERROR</span><br><span class="line">componentstatus/controller-manager   Healthy   ok                   </span><br><span class="line">componentstatus/scheduler            Healthy   ok                   </span><br><span class="line">componentstatus/etcd-0               Healthy   &#123;"health": "true"&#125;   </span><br><span class="line">master@master:~$</span><br></pre></td></tr></table></figure><h2 id="5-4-配置Node">5.4 配置Node</h2><h3 id="5-4-1-确认外部环境">5.4.1 确认外部环境</h3><ol><li>确认关闭swap</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt install -y selinux-utils</span><br><span class="line">swapoff -a</span><br></pre></td></tr></table></figure><ol start="2"><li>禁止selinux</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setenforce 0</span><br></pre></td></tr></table></figure><ol start="3"><li>确认关闭防火墙</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ufw disable</span><br></pre></td></tr></table></figure><h3 id="5-4-2-配置k8s集群的Node主机环境">5.4.2 配置k8s集群的Node主机环境</h3><ol><li>启动k8s后台服务</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 启动kubelet 设置为开机自启动</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo systemctl <span class="built_in">enable</span> kubelet</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动k8s服务程序</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo systemctl start kubelet</span></span><br></pre></td></tr></table></figure><ol start="2"><li><p>将master机器的<code>/etc/kubernetes/admin.conf</code>传到到node1和node2</p><p>登录 <code>master</code> 终端</p></li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">将admin.conf传递给node1</span></span><br><span class="line">sudo scp /etc/kubernetes/admin.conf itcast@192.168.236.178:/home/itcast/</span><br><span class="line"><span class="meta">#</span><span class="bash">将admin.conf传递给node2</span></span><br><span class="line">sudo scp /etc/kubernetes/admin.conf itcast@192.168.236.179:/home/itcast/</span><br></pre></td></tr></table></figure><ol start="3"><li>登录<code>node1</code>终端，创建基础kube配置文件环境</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">$ sudo cp -i <span class="variable">$HOME</span>/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">$ sudo chown $(id -u):$(id -g) <span class="variable">$HOME</span>/.kube/config</span><br></pre></td></tr></table></figure><ol start="4"><li>登录<code>node2</code>终端，创建基础kube配置文件环境</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">$ sudo cp -i <span class="variable">$HOME</span>/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">$ sudo chown $(id -u):$(id -g) <span class="variable">$HOME</span>/.kube/config</span><br></pre></td></tr></table></figure><ol start="5"><li><code>node1</code>和<code>node2</code>分别连接<code>master</code>加入master集群。这里用的是<code>kubeadm join</code>指令</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo kubeadm join 192.168.236.177:6443 --token l0b9f2.k68na0930je4bomg --discovery-token-ca-cert-hash sha256:71e5fe5bc4729cf48567f9296752a71668f18accb4f151facb1267fe35429493</span></span><br></pre></td></tr></table></figure><p>​	这里要注意，使用的hash应该是 <code>master</code> 主机 <code>kubeadm init</code> 成功之后生成的hash码。</p><p>​	如果初始化时忘记保存：</p><p>​	master生成token: <code>kubeadm token create</code></p><p>​	hash: <code>openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2&gt;/dev/null | openssl dgst -sha256 -hex | sed 's/^.* //'</code></p><p>​</p><ol start="6"><li>应用两个node主机分别应用flannel网络</li></ol><p>将 <code>master</code> 中的 <code>kube-flannel.yml</code> 分别传递给两个 <code>node</code> 节点.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#将kube-flannel.yml传递给node1</span></span><br><span class="line">sudo scp <span class="variable">$HOME</span>/working/kube-flannel.yml itcast@192.168.236.178:/home/itcast/</span><br><span class="line"><span class="comment">#将kube-flannel.yml传递给node2</span></span><br><span class="line">sudo scp <span class="variable">$HOME</span>/working/kube-flannel.yml itcast@192.168.236.179:/home/itcast/</span><br></pre></td></tr></table></figure><p>被墙了，手动安装docker, 去官网找，迅雷下载</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker load &lt; flanneld-v0.11.0-amd64.docker</span><br></pre></td></tr></table></figure><p>分别启动 <code>flannel</code> 网络</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">itcast@node1:~$ kubectl apply -f kube-flannel.yml</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">itcast@node2:~$ kubectl apply -f kube-flannel.yml</span><br></pre></td></tr></table></figure><ol start="7"><li>查看node是否已经加入到k8s集群中(需要等一段时间才能ready)</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">itcast@node2:~$ kubectl get nodes</span><br><span class="line">NAME     STATUS   ROLES    AGE     VERSION</span><br><span class="line">master   Ready    master   35m     v1.13.1</span><br><span class="line">node1    Ready    &lt;none&gt;   2m23s   v1.13.1</span><br><span class="line">node2    Ready    &lt;none&gt;   40s     v1.13.1</span><br></pre></td></tr></table></figure><p>​	8. 等待的过程中看看日志</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod,cs -n kube-system</span><br><span class="line"> </span><br><span class="line">journalctl -f -u kubelet</span><br></pre></td></tr></table></figure><p>好像出现多个pod，可能yml 配置了多个, 或者配置flanneld 的时候被墙了导致多次apply启动了多个</p><p>比如下文tomcat-rc.yml中 replicas: 5 pod定义了5个，那么kubectl会拉一个tomcat镜像，并且启动5个docker容器（但是pod都在在从节点上，因为镜像就在从节点上，不晓得从节点挂掉后，其他节点会不会重新拉去镜像，并启动5个docker实例）</p><p>这应该输入集群模式，5个tomcat都在一台服务器上</p><p>k8s还有分布式模式，在多台服务器，以后自己去研究</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">slave2@slave2:~$ kubectl get pod,cs -n kube-system</span><br><span class="line">NAME                                 READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/coredns-59b69b999c-qj7m7         1/1     Running   0          18h</span><br><span class="line">pod/coredns-59b69b999c-sc67w         1/1     Running   0          18h</span><br><span class="line">pod/etcd-master                      1/1     Running   2          18h</span><br><span class="line">pod/kube-apiserver-master            1/1     Running   2          18h</span><br><span class="line">pod/kube-controller-manager-master   1/1     Running   2          18h</span><br><span class="line">pod/kube-flannel-ds-6m9cg            1/1     Running   0          48m</span><br><span class="line">pod/kube-flannel-ds-amd64-nlc8h      1/1     Running   0          13m</span><br><span class="line">pod/kube-flannel-ds-amd64-nx5bp      1/1     Running   0          12h</span><br><span class="line">pod/kube-flannel-ds-wn84n            1/1     Running   0          13m</span><br><span class="line">pod/kube-proxy-5fms7                 1/1     Running   0          13m</span><br><span class="line">pod/kube-proxy-7drcn                 1/1     Running   2          18h</span><br><span class="line">pod/kube-scheduler-master            1/1     Running   2          18h</span><br><span class="line"></span><br><span class="line">NAME                                 STATUS    MESSAGE              ERROR</span><br><span class="line">componentstatus/scheduler            Healthy   ok                   </span><br><span class="line">componentstatus/controller-manager   Healthy   ok                   </span><br><span class="line">componentstatus/etcd-0               Healthy   &#123;"health": "true"&#125;   </span><br><span class="line">slave2@slave2:~$</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">slave2@slave2:~$ kubectl get nodes</span><br><span class="line">NAME     STATUS   ROLES    AGE   VERSION</span><br><span class="line">master   Ready    master   18h   v1.13.1</span><br><span class="line">slave2   Ready    &lt;none&gt;   14m   v1.13.1</span><br><span class="line">slave2@slave2:~$</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">journalctl -f -u kubelet</span><br><span class="line"><span class="meta">#</span><span class="bash"> 没有刷新新的异常信息了，成功了。</span></span><br></pre></td></tr></table></figure><p>master 的ifconfig</p><p>`</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">master@master:/etc/kubernetes$ ifconfig</span><br><span class="line">cni0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1450</span><br><span class="line">        inet 10.244.0.1  netmask 255.255.255.0  broadcast 0.0.0.0</span><br><span class="line">        inet6 fe80::c0b7:a6ff:fe2e:98ae  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether 0a:58:0a:f4:00:01  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 10067  bytes 648778 (648.7 KB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 10494  bytes 3805745 (3.8 MB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">docker0: flags=4099&lt;UP,BROADCAST,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 172.17.0.1  netmask 255.255.0.0  broadcast 172.17.255.255</span><br><span class="line">        ether 02:42:8b:26:60:f5  txqueuelen 0  (Ethernet)</span><br><span class="line">        RX packets 0  bytes 0 (0.0 B)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 0  bytes 0 (0.0 B)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">ens33: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.199.100  netmask 255.255.255.0  broadcast 192.168.199.255</span><br><span class="line">        inet6 fe80::20c:29ff:fef1:871f  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether 00:0c:29:f1:87:1f  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 97425  bytes 37310985 (37.3 MB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 103370  bytes 17686648 (17.6 MB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">flannel.1: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1450</span><br><span class="line">        inet 10.244.0.0  netmask 255.255.255.255  broadcast 0.0.0.0</span><br><span class="line">        inet6 fe80::b840:1aff:fe51:3a29  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether ba:40:1a:51:3a:29  txqueuelen 0  (Ethernet)</span><br><span class="line">        RX packets 0  bytes 0 (0.0 B)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 0  bytes 0 (0.0 B)</span><br><span class="line">        TX errors 0  dropped 15 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536</span><br><span class="line">        inet 127.0.0.1  netmask 255.0.0.0</span><br><span class="line">        inet6 ::1  prefixlen 128  scopeid 0x10&lt;host&gt;</span><br><span class="line">        loop  txqueuelen 1000  (Local Loopback)</span><br><span class="line">        RX packets 370854  bytes 90259280 (90.2 MB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 370854  bytes 90259280 (90.2 MB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">vethaccb9a86: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1450</span><br><span class="line">        inet6 fe80::8c24:eaff:fe02:ebe4  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether 8e:24:ea:02:eb:e4  txqueuelen 0  (Ethernet)</span><br><span class="line">        RX packets 5042  bytes 395491 (395.4 KB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 5260  bytes 1903955 (1.9 MB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">vethe4363cd7: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1450</span><br><span class="line">        inet6 fe80::28:fbff:feb6:4a17  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether 02:28:fb:b6:4a:17  txqueuelen 0  (Ethernet)</span><br><span class="line">        RX packets 5025  bytes 394225 (394.2 KB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 5281  bytes 1905216 (1.9 MB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">`</span><br></pre></td></tr></table></figure><p>slave2 的 ifconfig</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">slave2@slave2:~$ ifconfig</span><br><span class="line">docker0: flags=4099&lt;UP,BROADCAST,MULTICAST&gt;  mtu 1500</span><br><span class="line">        ether 02:42:f4:64:83:b6  txqueuelen 0  (Ethernet)</span><br><span class="line">        RX packets 0  bytes 0 (0.0 B)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 0  bytes 0 (0.0 B)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">ens33: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.199.102  netmask 255.255.255.0  broadcast 192.168.199.255</span><br><span class="line">        inet6 fe80::20c:29ff:feac:126b  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether 00:0c:29:ac:12:6b  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 326900  bytes 163821016 (163.8 MB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 457277  bytes 61005420 (61.0 MB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">flannel.1: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1450</span><br><span class="line">        inet 10.244.1.0  netmask 255.255.255.255  broadcast 0.0.0.0</span><br><span class="line">        inet6 fe80::d420:f3ff:fec0:dbe4  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether d6:20:f3:c0:db:e4  txqueuelen 0  (Ethernet)</span><br><span class="line">        RX packets 0  bytes 0 (0.0 B)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 0  bytes 0 (0.0 B)</span><br><span class="line">        TX errors 0  dropped 12 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536</span><br><span class="line">        inet 127.0.0.1  netmask 255.0.0.0</span><br><span class="line">        inet6 ::1  prefixlen 128  scopeid 0x10&lt;host&gt;</span><br><span class="line">        loop  txqueuelen 1000  (Local Loopback)</span><br><span class="line">        RX packets 538  bytes 45426 (45.4 KB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 538  bytes 45426 (45.4 KB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">slave2@slave2:~$</span><br></pre></td></tr></table></figure><p>可以看出master多出来几个网络配置，以后可以研究</p><h1>六、应用实例</h1><h2 id="6-1-创建MySQL实例">6.1 创建MySQL实例</h2><h3 id="6-1-1-定义描述文件">6.1.1 定义描述文件</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ReplicationController</span>                            <span class="comment">#副本控制器RC</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysql</span>                                          <span class="comment">#RC的名称，全局唯一</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span>                                          <span class="comment">#Pod副本的期待数量</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">mysql</span>                                         <span class="comment">#符合目标的Pod拥有此标签</span></span><br><span class="line">  <span class="attr">template:</span>                                            <span class="comment">#根据此模板创建Pod的副本（实例）</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">mysql</span>                                     <span class="comment">#Pod副本拥有的标签，对应RC的Selector</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span>                                      <span class="comment">#Pod内容器的定义部分</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysql</span>                                    <span class="comment">#容器的名称</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">image:</span> <span class="string">hub.c.163.com/library/mysql</span>              <span class="comment">#容器对应的Docker image</span></span><br><span class="line">        <span class="attr">ports:</span> </span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">3306</span>                          <span class="comment">#容器应用监听的端口号</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">env:</span>                                           <span class="comment">#注入容器内的环境变量</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_ROOT_PASSWORD</span> </span><br><span class="line"></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"123456"</span></span><br></pre></td></tr></table></figure><h3 id="6-1-2-加载ReplicationController副本控制器描述文件">6.1.2 加载ReplicationController副本控制器描述文件</h3><p>创建好mysql-rc.yaml后，在master节点使用kubectl命令将它发布到k8s集群中。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f mysql-rc.yaml</span><br></pre></td></tr></table></figure><h3 id="6-1-3-查看启动状态">6.1.3 查看启动状态</h3><p>通过查看当前的 <code>pods</code> 列表，是否已经启动成功:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe pod mysql</span><br><span class="line">kubectl get pod</span><br></pre></td></tr></table></figure><h3 id="6-1-4-网络异常解决方案-未出现问题可直接跳过">6.1.4 网络异常解决方案(未出现问题可直接跳过)</h3><p>注意：如果这里出现了 <code>ContainerCreating</code> 状态，那么可以尝试如下解决办法:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">itcast@master:~/working$ kubectl get pods</span><br><span class="line">NAME          READY   STATUS              RESTARTS   AGE</span><br><span class="line">mysql-tscrh   0/1     ContainerCreating   0          17m</span><br></pre></td></tr></table></figure><p>目前mysql-tscrh 描述文件 已经创建，但是没有启动成功. 状态是 <code>ContainerCreating</code> 没有启动起来.</p><p>通过 <code>kubectl describe pods</code> 来查看 <code>pods</code> 的详细状态</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">itcast@master:~/working$ kubectl describe pods mysql</span><br><span class="line">Name:               mysql-tscrh</span><br><span class="line">Namespace:          default</span><br><span class="line">Priority:           0</span><br><span class="line">PriorityClassName:  &lt;none&gt;</span><br><span class="line">Node:               node1/192.168.236.178</span><br><span class="line">Start Time:         Mon, 17 Jun 2019 09:10:35 +0000</span><br><span class="line">Labels:             app=mysql</span><br><span class="line">Annotations:        &lt;none&gt;</span><br><span class="line">Status:             Pending</span><br><span class="line">IP:                 </span><br><span class="line">Controlled By:      ReplicationController/mysql</span><br><span class="line">Containers:</span><br><span class="line">  mysql:</span><br><span class="line">    Container ID:   </span><br><span class="line">    Image:          hub.c.163.com/library/mysql</span><br><span class="line">    Image ID:       </span><br><span class="line">    Port:           3306/TCP</span><br><span class="line">    Host Port:      0/TCP</span><br><span class="line">    State:          Waiting</span><br><span class="line">      Reason:       ContainerCreating</span><br><span class="line">    Ready:          False</span><br><span class="line">    Restart Count:  0</span><br><span class="line">    Environment:</span><br><span class="line">      MYSQL_ROOT_PASSWORD:  123456</span><br><span class="line">    Mounts:</span><br><span class="line">      /var/run/secrets/kubernetes.io/serviceaccount from default-token-q6ggq (ro)</span><br><span class="line">Conditions:</span><br><span class="line">  Type              Status</span><br><span class="line">  Initialized       True </span><br><span class="line">  Ready             False </span><br><span class="line">  ContainersReady   False </span><br><span class="line">  PodScheduled      True </span><br><span class="line">Volumes:</span><br><span class="line">  default-token-q6ggq:</span><br><span class="line">    Type:        Secret (a volume populated by a Secret)</span><br><span class="line">    SecretName:  default-token-q6ggq</span><br><span class="line">    Optional:    <span class="literal">false</span></span><br><span class="line">QoS Class:       BestEffort</span><br><span class="line">Node-Selectors:  &lt;none&gt;</span><br><span class="line">Tolerations:     node.kubernetes.io/not-ready:NoExecute <span class="keyword">for</span> 300s</span><br><span class="line">                 node.kubernetes.io/unreachable:NoExecute <span class="keyword">for</span> 300s</span><br><span class="line">Events:</span><br><span class="line">  Type     Reason                  Age                     From               Message</span><br><span class="line">  ----     ------                  ----                    ----               -------</span><br><span class="line">  Normal   Scheduled               22m                     default-scheduler  Successfully assigned default/mysql-tscrh to node1</span><br><span class="line">  Warning  FailedCreatePodSandBox  22m                     kubelet, node1     Failed create pod sandbox: rpc error: code = Unknown desc = failed to <span class="built_in">set</span> up sandbox container <span class="string">"58d143373e767c40610587624c667d8e20dd77fa397952406a085f2ae1dc38e6"</span> network <span class="keyword">for</span> pod <span class="string">"mysql-tscrh"</span>: NetworkPlugin cni failed to <span class="built_in">set</span> up pod <span class="string">"mysql-tscrh_default"</span> network: open /run/flannel/subnet.env: no such file or directory</span><br><span class="line">  Warning  FailedCreatePodSandBox  22m                     kubelet, node1     Failed create pod sandbox: rpc error: code = Unknown desc = failed to <span class="built_in">set</span> up sandbox container <span class="string">"81d12726dbe075c64af48142638e98863231e8201ccc292f0dda1fccfa7fdaec"</span> network <span class="keyword">for</span> pod <span class="string">"mysql-tscrh"</span>: NetworkPlugin cni failed to <span class="built_in">set</span> up pod <span class="string">"mysql-tscrh_default"</span> network: open /run/flannel/subnet.env: no such file or directory</span><br><span class="line">  Warning  FailedCreatePodSandBox  22m                     kubelet, node1     Failed create pod sandbox: rpc error: code = Unknown desc = failed to <span class="built_in">set</span> up sandbox container <span class="string">"8bd77ee0176d369435ead7bd3c2675b7bbcbdc2b052cf34c784f04053a7d5288"</span> network <span class="keyword">for</span> pod <span class="string">"mysql-tscrh"</span>: NetworkPlugin cni failed to <span class="built_in">set</span> up pod <span class="string">"mysql-tscrh_default"</span> network: open /run/flannel/subnet.env: no such file or directory</span><br><span class="line">  Warning  FailedCreatePodSandBox  22m                     kubelet, node1     Failed create pod sandbox: rpc error: code = Unknown desc = failed to <span class="built_in">set</span> up sandbox container <span class="string">"0733fc209e085e96f5823a2280b012a609dace41fda967c5ae951005a8699ce6"</span> network <span class="keyword">for</span> pod <span class="string">"mysql-tscrh"</span>: NetworkPlugin cni failed to <span class="built_in">set</span> up pod <span class="string">"mysql-tscrh_default"</span> network: open /run/flannel/subnet.env: no such file or directory</span><br><span class="line">  Warning  FailedCreatePodSandBox  22m                     kubelet, node1     Failed create pod sandbox: rpc error: code = Unknown desc = failed to <span class="built_in">set</span> up sandbox container <span class="string">"91f337eb334612b2e7426d820ba4b15a9c9c549050517d459508832b69780b5f"</span> network <span class="keyword">for</span> pod <span class="string">"mysql-tscrh"</span>: NetworkPlugin cni failed to <span class="built_in">set</span> up pod <span class="string">"mysql-tscrh_default"</span> network: open /run/flannel/subnet.env: no such file or directory</span><br><span class="line">  Warning  FailedCreatePodSandBox  22m                     kubelet, node1     Failed create pod sandbox: rpc error: code = Unknown desc = failed to <span class="built_in">set</span> up sandbox container <span class="string">"48cbba9896068a774d9128a6864394e8726a0d857bae61036421ad73f5d6e3dd"</span> network <span class="keyword">for</span> pod <span class="string">"mysql-tscrh"</span>: NetworkPlugin cni failed to <span class="built_in">set</span> up pod <span class="string">"mysql-tscrh_default"</span> network: open /run/flannel/subnet.env: no such file or directory</span><br><span class="line">  Warning  FailedCreatePodSandBox  22m                     kubelet, node1     Failed create pod sandbox: rpc error: code = Unknown desc = failed to <span class="built_in">set</span> up sandbox container <span class="string">"d259778aa19418a9a429b3175b66afae3d8ffb7324ec9df492b2947dbc153460"</span> network <span class="keyword">for</span> pod <span class="string">"mysql-tscrh"</span>: NetworkPlugin cni failed to <span class="built_in">set</span> up pod <span class="string">"mysql-tscrh_default"</span> network: open /run/flannel/subnet.env: no such file or directory</span><br><span class="line">  Warning  FailedCreatePodSandBox  22m                     kubelet, node1     Failed create pod sandbox: rpc error: code = Unknown desc = failed to <span class="built_in">set</span> up sandbox container <span class="string">"3d01c00ac9eaac7b2e983402be38c1cf60c4bbd1d454aa45329ce0ca0c2bf792"</span> network <span class="keyword">for</span> pod <span class="string">"mysql-tscrh"</span>: NetworkPlugin cni failed to <span class="built_in">set</span> up pod <span class="string">"mysql-tscrh_default"</span> network: open /run/flannel/subnet.env: no such file or directory</span><br><span class="line">  Warning  FailedCreatePodSandBox  22m                     kubelet, node1     Failed create pod sandbox: rpc error: code = Unknown desc = failed to <span class="built_in">set</span> up sandbox container <span class="string">"98879cbb0405dac3a24753dd1986070a53fe9ee9f1b819996a903c19286a2bb7"</span> network <span class="keyword">for</span> pod <span class="string">"mysql-tscrh"</span>: NetworkPlugin cni failed to <span class="built_in">set</span> up pod <span class="string">"mysql-tscrh_default"</span> network: open /run/flannel/subnet.env: no such file or directory</span><br><span class="line">  Warning  FailedCreatePodSandBox  7m49s (x838 over 22m)   kubelet, node1     (combined from similar events): Failed create pod sandbox: rpc error: code = Unknown desc = failed to <span class="built_in">set</span> up sandbox container <span class="string">"60923335b41c2d0412b279bdb6150f9b9b7eae20c4a02549e35509083c01384b"</span> network <span class="keyword">for</span> pod <span class="string">"mysql-tscrh"</span>: NetworkPlugin cni failed to <span class="built_in">set</span> up pod <span class="string">"mysql-tscrh_default"</span> network: open /run/flannel/subnet.env: no such file or directory</span><br><span class="line">  Normal   SandboxChanged          2m49s (x1127 over 22m)  kubelet, node1     Pod sandbox changed, it will be killed and re-created.</span><br></pre></td></tr></table></figure><p>会看到一个错误:</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="string">"mysql-tscrh"</span>: NetworkPlugin cni failed <span class="keyword">to</span> <span class="keyword">set</span> <span class="keyword">up</span> pod <span class="string">"mysql-tscrh_default"</span> network: <span class="keyword">open</span> /run/flannel/subnet.<span class="keyword">en</span><span class="variable">v:</span> <span class="keyword">no</span> such <span class="keyword">file</span> <span class="built_in">or</span> directory</span><br></pre></td></tr></table></figure><p>这是缺少/run/flannel/subnet.env文件</p><h5 id="解决办法：配置flannel网络">解决办法：配置flannel网络</h5><p>分别在三台服务器上执行如下步骤</p><ol><li>创建目录</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir -p /run/flannel</span><br></pre></td></tr></table></figure><ol start="2"><li>创建环境描述文件</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo tee /run/flannel/subnet.env &lt;&lt;-<span class="string">'EOF'</span></span></span><br><span class="line">FLANNEL_NETWORK=10.244.0.0/16</span><br><span class="line">FLANNEL_SUBNET=10.244.0.1/24</span><br><span class="line">FLANNEL_MTU=1450</span><br><span class="line">FLANNEL_IPMASQ=true</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="6-1-5-查看mysql实例集群状态">6.1.5 查看mysql实例集群状态</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">itcast@master:~/working$ kubectl get pods</span><br><span class="line">NAME          READY   STATUS              RESTARTS   AGE</span><br><span class="line">mysql-tscrh   0/1     Running   0          17m</span><br></pre></td></tr></table></figure><p>如果为 <code>Running</code> 状态，则为mysql集群启动成功。</p><h2 id="6-2-创建Tomcat实例">6.2 创建Tomcat实例</h2><h3 id="6-2-1-定义描述文件">6.2.1 定义描述文件</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ReplicationController</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myweb</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">5</span>                                       <span class="comment">#Pod副本期待数量为5</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myweb</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">myweb</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myweb</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">image:</span> <span class="string">docker.io/kubeguide/tomcat-app:v1</span></span><br><span class="line">        <span class="attr">ports:</span> </span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_SERVICE_HOST</span></span><br><span class="line"></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"mysql"</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_SERVICE_PORT</span></span><br><span class="line"></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"3306"</span></span><br></pre></td></tr></table></figure><p>tomcat-rc.yml中 replicas: 5 pod定义了5个，那么kubectl会拉一个tomcat镜像，并且启动5个docker容器（但是pod都在在从节点上，因为镜像就在从节点上，不晓得从节点挂掉后，其他节点会不会重新拉去镜像，并启动5个docker实例）</p><p>这应该输入集群模式，5个tomcat都在一台服务器上</p><p>k8s还有分布式模式，在多台服务器，以后自己去研究</p><h3 id="6-2-2-加载RC副本描述文件">6.2.2 加载RC副本描述文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl create -f myweb-rc.yaml</span></span><br><span class="line">replicationcontroller/myweb created</span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl get rc</span></span><br><span class="line">NAME    DESIRED   CURRENT   READY   AGE</span><br><span class="line">mysql   1         1         0       4m22s</span><br><span class="line">myweb   5         5         0       7s</span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl get pods</span></span><br><span class="line">NAME          READY   STATUS              RESTARTS   AGE</span><br><span class="line">mysql-tp69s   1/1     Running             0          21s</span><br><span class="line">myweb-266mz   0/1     ContainerCreating   0          2s</span><br><span class="line">myweb-j7nl7   0/1     ContainerCreating   0          2s</span><br><span class="line">myweb-s7drm   0/1     ContainerCreating   0          2s</span><br><span class="line">myweb-sq4ns   0/1     ContainerCreating   0          2s</span><br><span class="line">myweb-t4vlf   0/1     ContainerCreating   0          2s</span><br><span class="line"><span class="meta">$</span></span><br></pre></td></tr></table></figure><p>注意mysql实例 状态 <code>Running</code></p><p>myweb实例状态 <code>ContainerCreating</code></p><p>过几分钟myweb实例状态变成 <code>Running</code></p><h3 id="6-2-3-创建服务副本">6.2.3 创建服务副本</h3><p>在master服务器</p><ol><li>使用root用户登录，并切换到working目录 <code>cd /root/working</code></li><li>创建描述服务描述文件<code>myweb-svc.yaml</code></li></ol><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myweb</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">30001</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myweb</span></span><br></pre></td></tr></table></figure><p>之前5个tomcat仅仅是kubenetes内部之前通信，需要开一个服务(30001端口)给外网，别人调用这个服务，这个服务将请求转发给内部的tomcat。有点像nginx</p><h3 id="6-2-4-部署服务">6.2.4 部署服务</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$kubectl</span> create -f myweb-svc.yaml</span><br></pre></td></tr></table></figure><h3 id="6-2-5-验证">6.2.5 验证</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl get pods</span></span><br><span class="line">NAME          READY   STATUS    RESTARTS   AGE</span><br><span class="line">mysql-tp69s   1/1     Running   0          15m</span><br><span class="line">myweb-266mz   1/1     Running   0          14m</span><br><span class="line">myweb-j7nl7   1/1     Running   0          14m</span><br><span class="line">myweb-s7drm   1/1     Running   0          14m</span><br><span class="line">myweb-sq4ns   1/1     Running   0          14m</span><br><span class="line">myweb-t4vlf   1/1     Running   0          14m</span><br></pre></td></tr></table></figure><p>查看service</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">itcast@master:~/working$ kubectl get service     </span><br><span class="line">NAME         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">kubernetes   ClusterIP   10.96.0.1        &lt;none&gt;        443/TCP          19h</span><br><span class="line">myweb        NodePort    10.109.234.197   &lt;none&gt;        8080:30001/TCP   25m</span><br></pre></td></tr></table></figure><p>已经看到已经有一个 <code>myweb</code> 服务已经启动</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">itcast@master:~/working$ kubectl describe service myweb</span><br><span class="line">Name:                     myweb</span><br><span class="line">Namespace:                default</span><br><span class="line">Labels:                   &lt;none&gt;</span><br><span class="line">Annotations:              &lt;none&gt;</span><br><span class="line">Selector:                 app=myweb</span><br><span class="line">Type:                     NodePort</span><br><span class="line">IP:                       10.109.234.197</span><br><span class="line">Port:                     &lt;<span class="built_in">unset</span>&gt;  8080/TCP</span><br><span class="line">TargetPort:               8080/TCP</span><br><span class="line">NodePort:                 &lt;<span class="built_in">unset</span>&gt;  30001/TCP</span><br><span class="line">Endpoints:                10.244.0.6:8080,10.244.0.6:8080,10.244.0.7:8080 + 2 more...</span><br><span class="line">Session Affinity:         None</span><br><span class="line">External Traffic Policy:  Cluster</span><br><span class="line">Events:                   &lt;none&gt;</span><br></pre></td></tr></table></figure><p>service详情这里的IP就是CLUSTER-IP. CLUSTER-IP是和service绑定的。</p><p>service详情这里的Port就是Service的端口号。</p><p>service详情这里的NodePort就是Node的真实端口号。</p><p>service详情这里的Endpoints就是容器的IP和port。</p><p>验证端口号</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> netstat -tlp|grep 30001</span></span><br><span class="line">tcp6       0      0 [::]:30001              [::]:*                  LISTEN      4333/kube-proxy</span><br><span class="line"><span class="meta">$</span></span><br></pre></td></tr></table></figure><p>我们可以打开浏览器，输入master/node1/node2任何一个地址家30001端口都可以，访问tomcat服务。</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="symbol">http:</span><span class="comment">//192.168.236.177:30001</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># 自己配的</span></span><br><span class="line"><span class="symbol">http:</span><span class="comment">//192.168.199.102:30001/</span></span><br><span class="line"><span class="symbol">http:</span><span class="comment">//192.168.199.100:30001/</span></span><br></pre></td></tr></table></figure><p>如果遇到问题，之间先重启</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shutdown -r now</span><br></pre></td></tr></table></figure><h2 id="部署面板-dashboard">部署面板 dashboard</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker pull registry.aliyuncs.com/google_containers/kubernetes-dashboard-amd64:v1.10.0</span><br><span class="line">docker tag registry.aliyuncs.com/google_containers/kubernetes-dashboard-amd64:v1.10.0 k8s.gcr.io/kubernetes-dashboard-amd64:v1.10.0</span><br></pre></td></tr></table></figure><p>网站被墙，手动引用，注意下版本：v1.10.0</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f dashboard.yml</span><br></pre></td></tr></table></figure><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard-certs</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard-minimal</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"></span><br><span class="line"><span class="string">*</span> <span class="attr">apiGroups:</span> <span class="string">[""]</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">resources:</span> <span class="string">["secrets"]</span></span><br><span class="line">  <span class="attr">verbs:</span> <span class="string">["create"]</span></span><br><span class="line"></span><br><span class="line"><span class="string">*</span> <span class="attr">apiGroups:</span> <span class="string">[""]</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">resources:</span> <span class="string">["configmaps"]</span></span><br><span class="line">  <span class="attr">verbs:</span> <span class="string">["create"]</span></span><br><span class="line"></span><br><span class="line"><span class="string">*</span> <span class="attr">apiGroups:</span> <span class="string">[""]</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">resources:</span> <span class="string">["secrets"]</span></span><br><span class="line">  <span class="attr">resourceNames:</span> <span class="string">["kubernetes-dashboard-key-holder",</span> <span class="string">"kubernetes-dashboard-certs"</span><span class="string">]</span></span><br><span class="line">  <span class="attr">verbs:</span> <span class="string">["get",</span> <span class="string">"update"</span><span class="string">,</span> <span class="string">"delete"</span><span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="string">*</span> <span class="attr">apiGroups:</span> <span class="string">[""]</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">resources:</span> <span class="string">["configmaps"]</span></span><br><span class="line">  <span class="attr">resourceNames:</span> <span class="string">["kubernetes-dashboard-settings"]</span></span><br><span class="line">  <span class="attr">verbs:</span> <span class="string">["get",</span> <span class="string">"update"</span><span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="string">*</span> <span class="attr">apiGroups:</span> <span class="string">[""]</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">resources:</span> <span class="string">["services"]</span></span><br><span class="line">  <span class="attr">resourceNames:</span> <span class="string">["heapster"]</span></span><br><span class="line">  <span class="attr">verbs:</span> <span class="string">["proxy"]</span></span><br><span class="line"></span><br><span class="line"><span class="string">*</span> <span class="attr">apiGroups:</span> <span class="string">[""]</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">resources:</span> <span class="string">["services/proxy"]</span></span><br><span class="line">  <span class="attr">resourceNames:</span> <span class="string">["heapster",</span> <span class="string">"http:heapster:"</span><span class="string">,</span> <span class="string">"https:heapster:"</span><span class="string">]</span></span><br><span class="line">  <span class="attr">verbs:</span> <span class="string">["get"]</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard-minimal</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard-minimal</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"></span><br><span class="line"><span class="string">*</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1beta2</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">image:</span> <span class="string">k8s.gcr.io/kubernetes-dashboard-amd64:v1.10.0</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8443</span></span><br><span class="line"></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">        <span class="attr">args:</span></span><br><span class="line"></span><br><span class="line">          <span class="bullet">-</span> <span class="string">--auto-generate-certificates</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kubernetes-dashboard-certs</span></span><br><span class="line"></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/certs</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/tmp</span></span><br><span class="line"></span><br><span class="line">          <span class="attr">name:</span> <span class="string">tmp-volume</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">scheme:</span> <span class="string">HTTPS</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8443</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line">          <span class="attr">timeoutSeconds:</span> <span class="number">30</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kubernetes-dashboard-certs</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">secret:</span></span><br><span class="line">          <span class="attr">secretName:</span> <span class="string">kubernetes-dashboard-certs</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tmp-volume</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">emptyDir:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">node-role.kubernetes.io/master</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">443</span></span><br><span class="line"></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8443</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br></pre></td></tr></table></figure><p>查看k8s系统pod需要加上kubernetes-dashboard</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system edit service kubernetes-dashboard</span><br><span class="line"><span class="meta">#</span><span class="bash"> -n kube-system means --namespace = kube-system</span></span><br></pre></td></tr></table></figure><p>查看日志</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubernetes-dashboard</span><br></pre></td></tr></table></figure><p>暴露端口，修改 <code>type: ClusterIP</code> -&gt; <code>type: NodePort</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system edit service kubernetes-dashboard</span><br></pre></td></tr></table></figure><p>查看服务</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl  get service kubernetes-dashboard -n kube-system</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">master@master:~/yangbo/yml$ kubectl  get service kubernetes-dashboard -n kube-system</span><br><span class="line">NAME                   TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)         AGE</span><br><span class="line">kubernetes-dashboard   NodePort   10.108.251.134   &lt;none&gt;        443:32681/TCP   34m</span><br><span class="line">master@master:~/yangbo/yml$</span><br></pre></td></tr></table></figure><p>浏览器输入</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://192.168.199.100:32681/</span><br></pre></td></tr></table></figure><p>遇到的问题</p><p>过段时间后发现面板浏览器看不到了</p><p>首先重启系统</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shutdown -r now</span><br></pre></td></tr></table></figure><p>查看dashoboard面板 pod状态：不是运行状态running 而是CrashLoopBackOff</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods -n kube-system</span><br></pre></td></tr></table></figure><p>查看logs</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl logs  kubernetes-dashboard-79ff88449c-tlcxk -n kube-system</span><br></pre></td></tr></table></figure><p>最终解决方法：删除pod就完事了，deployment会重新启动一个pod</p><p>查看面板 deployment命令</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get deployment -n kube-system</span><br></pre></td></tr></table></figure><p>另外还有一个方法，好像是配置文件的问题, 可以参考下</p><p><a href="https://www.jianshu.com/p/f9a2bd82e368" target="_blank" rel="noopener">地址</a></p><p>关于pod，deployement 的一些关系</p><p>pod是最小单元</p><p>replicationController管理pod</p><p>deployment继承了replicationController，功能更强大</p><p>server 是在以上基础之上提供给外部的服务，类似nginx将内网也外网映射</p><p>endpoint 是资源对象</p><p><strong>一句话可以治好强迫症：在application.yml中 的kind 不是只能配置一种，而是可以同时配置与整个服务相关的多个kind。所以不要纠结启动一个pod 到底要选择什么样的kind。没事看看dashboard.yml中的kind就好了。</strong></p><p>谷歌提示缺少证书, 不让访问</p><p>换成火狐就好了</p><p>进去后没有权限令牌等，看不到信息</p><p>创建service account并绑定默认cluster-admin管理员集群角色：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl create serviceaccount dashboard-admin -n kube-system</span><br><span class="line">kubectl create clusterrolebinding dashboard-admin --clusterrole=cluster-admin --serviceaccount=kube-system:dashboard-admin</span><br><span class="line">kubectl describe secrets -n kube-system $(kubectl -n kube-system get secret | awk '/dashboard-admin/&#123;print $1&#125;')</span><br></pre></td></tr></table></figure><p>拿到token就可以访问了</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">master@master:~/yangbo/yml$ kubectl describe secrets -n kube-system $(kubectl -n kube-system get secret | awk '/dashboard-admin/&#123;print $1&#125;')</span><br><span class="line">Name:         dashboard-admin-token-rglzh</span><br><span class="line">Namespace:    kube-system</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  kubernetes.io/service-account.name: dashboard-admin</span><br><span class="line">              kubernetes.io/service-account.uid: 2f9c7a2b-df93-11ea-951c-000c29f1871f</span><br><span class="line"></span><br><span class="line">Type:  kubernetes.io/service-account-token</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">ca.crt:     1025 bytes</span><br><span class="line">namespace:  11 bytes</span><br><span class="line">token:      eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJkYXNoYm9hcmQtYWRtaW4tdG9rZW4tcmdsemgiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiZGFzaGJvYXJkLWFkbWluIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQudWlkIjoiMmY5YzdhMmItZGY5My0xMWVhLTk1MWMtMDAwYzI5ZjE4NzFmIiwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50Omt1YmUtc3lzdGVtOmRhc2hib2FyZC1hZG1pbiJ9.N0j64xzfocege-S-GR0r5xlxVTHfbGJ_TH6QtsWq08v2WPMX0DIT1ZSG9cVUPaDyxdTTpkT1JrAcJvqW8PORsJFNZyw22ppYQRDm6MuqMykkmxiRjyx3LGQoYTv2A52SMoiLk1Q60fEpXiJgJC1U38H51yhsDOdDP--ozvOAGzscJNs-uYixcySk1q901m73yXZaXJQPT3dylLV8amRSMb-EYkqiFrAmFGZyOngoySDWGmxG-j2mOgWvuWYjkhS5a8dmEjTasi2Iu6Vo2LNtvYwYBGhP1f2i8gxt-GQQdU089fK5jd8M5wpI-T0Y0EVrNv4a4FxVLKj1838E6zZtEA</span><br><span class="line">master@master:~/yangbo/yml$</span><br></pre></td></tr></table></figure><p>成功！！</p><p><img src="https://ybvip.oss-cn-shanghai.aliyuncs.com/blog/20200816154529.png" alt></p><p><img src="https://ybvip.oss-cn-shanghai.aliyuncs.com/blog/20200816155725.png" alt></p><p><img src="https://ybvip.oss-cn-shanghai.aliyuncs.com/blog/20200816160114.png" alt></p><p>哈哈哈，完毕</p><p>以下未实践====================</p><h2 id="6-3-创建自定义的Beego-应用web程序集群">6.3 创建自定义的Beego 应用web程序集群</h2><h3 id="6-3-1-初始化mysql">6.3.1 初始化mysql</h3><ol><li>找到我们之前创建好的mysql的pod的<code>NAME</code></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">itcast@master:~$ kubectl get pods</span><br><span class="line">NAME          READY   STATUS    RESTARTS   AGE</span><br><span class="line">mysql-kjdz8   1/1     Running   2          4d23h</span><br><span class="line">myweb-f7rt4   1/1     Running   2          4d23h</span><br><span class="line">myweb-jjxbp   1/1     Running   2          4d23h</span><br><span class="line">myweb-k8rmt   1/1     Running   2          4d23h</span><br><span class="line">myweb-rht8n   1/1     Running   2          4d23h</span><br><span class="line">myweb-wsgzw   1/1     Running   2          4d23h</span><br></pre></td></tr></table></figure><ol start="2"><li>查看当前pod的详细信息</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">itcast@master:~$ kubectl describe pod mysql-kjdz8</span><br></pre></td></tr></table></figure><ol start="3"><li>得到mysql在subnet内网的IP地址<code>10.244.1.8</code> 和登录密码</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">IP:                 10.244.1.8 </span><br><span class="line"> ...</span><br><span class="line"> Environment:</span><br><span class="line">      MYSQL_ROOT_PASSWORD:  123456</span><br></pre></td></tr></table></figure><ol start="4"><li>登录mysql实例，创建数据库</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">itcast@master:~$ kubectl <span class="built_in">exec</span> -it mysql-kjdz8 -- bash</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@mysql-kjdz8:/<span class="comment"># mysql -u root --password=123456 --default-character-set=utf8</span></span><br></pre></td></tr></table></figure><ol start="5"><li>创建数据库，注意大小写</li></ol><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> newsWeb  <span class="keyword">default</span> <span class="keyword">charset</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci;</span><br></pre></td></tr></table></figure><ol start="6"><li>使用数据库</li></ol><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> newsWeb</span><br></pre></td></tr></table></figure><h3 id="6-3-2-下载自定义的beego-docker-镜像">6.3.2 下载自定义的beego-docker 镜像</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">itcast@master:~$ docker pull registry.cn-shanghai.aliyuncs.com/itcast-golang/beego-microservices:v4</span><br><span class="line">921b31ab772b: Pull complete </span><br><span class="line">5dbef71438d6: Pull complete </span><br><span class="line">06b82a06d476: Pull complete </span><br><span class="line">903fde8a2004: Pull complete </span><br><span class="line">5102aca51d1d: Pull complete </span><br><span class="line">b0ebda6ce096: Pull complete </span><br><span class="line">1a243f1cae73: Pull complete </span><br><span class="line">Digest: sha256:7b83e5117d964f348750de76104d6302285410365aaf6e6a0d4f57edab7a0ad5</span><br><span class="line">Status: Downloaded newer image <span class="keyword">for</span> registry.cn-shanghai.aliyuncs.com/itcast-golang/beego-microservices:v4</span><br></pre></td></tr></table></figure><p>当然，目前该镜像地址是我们自己打包的，如果你想启动你自己的镜像应用，也需要打包成docker镜像放在阿里云或者其他docker仓库中。</p><p>cl</p><p>查看docker镜像是否已经下载成功。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">itcast@master:~$ docker images</span><br><span class="line">REPOSITORY                                                            TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">registry.cn-shanghai.aliyuncs.com/itcast-golang/beego-microservices   v4                  11f6f974f78b        35 minutes ago      23.1MB</span><br><span class="line">alpine                                                                latest              055936d39205        6 weeks ago         5.53MB</span><br><span class="line">registry.cn-beijing.aliyuncs.com/imcto/kube-controller-manager        v1.13.1             6ca952430d0a        3 months ago        146MB</span><br><span class="line">registry.cn-beijing.aliyuncs.com/imcto/kube-proxy                     v1.13.1             a311f9763fcc        3 months ago        80.2MB</span><br><span class="line">registry.cn-beijing.aliyuncs.com/imcto/coredns                        1.2.6               782ac1267b76        3 months ago        40MB</span><br><span class="line">registry.cn-beijing.aliyuncs.com/imcto/etcd                           3.2.24              399cf402bfe9        3 months ago        220MB</span><br><span class="line">registry.cn-beijing.aliyuncs.com/imcto/pause                          3.1                 73ae15a7a613        3 months ago        742kB</span><br><span class="line">registry.cn-beijing.aliyuncs.com/imcto/kube-scheduler                 v1.13.1             4b8df70aff4e        3 months ago        79.6MB</span><br><span class="line">registry.cn-beijing.aliyuncs.com/imcto/kube-apiserver                 v1.13.1             06924f18fe15        3 months ago        181MB</span><br><span class="line">quay.io/coreos/flannel                                                v0.11.0-amd64       ff281650a721        4 months ago        52.6MB</span><br></pre></td></tr></table></figure><h3 id="6-3-3-创建beego的RC副本文件">6.3.3 创建beego的RC副本文件</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ReplicationController</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">beego</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">5</span>                                       <span class="comment">#Pod副本期待数量为5</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">beego</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">beego</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">beego</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">image:</span> <span class="string">registry.cn-shanghai.aliyuncs.com/itcast-golang/beego-microservices:v4</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_SERVICE_HOST</span></span><br><span class="line"></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"10.244.1.8"</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_SERVICE_PORT</span></span><br><span class="line"></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"3306"</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_SERVICE_USER</span></span><br><span class="line"></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"root"</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_SERVICE_PASSWORD</span></span><br><span class="line"></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"123456"</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_SERVICE_DATABASE</span></span><br><span class="line"></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"newsWeb"</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">beego</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">30080</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">beego</span></span><br><span class="line"><span class="string">~</span></span><br></pre></td></tr></table></figure><p>这里要注意，里面的mysql环境变量IP、端口、数据库用户名密码等，都是我们上面实例获取到的。</p><p>这里实际上是在我们创建一个pods容器的时候，指定的一些环境变量。然后beego的应用程序会从系统中这些环境变量去取数据。</p><p>目前建立了NodePort端口映射，beegoWeb应用在内网的端口是8080，对外的映射端口是30080. 那么30080就是我们外网可以访问的端口号。</p><p>注意yml文件里面别多了空格</p><p>像 <code>value: &quot;10.244.1.8&quot;</code> 就被我写成了 <code>value: &quot;10.244.1.8空格&quot;</code></p><h3 id="6-3-4-装载RC副本文件，创建beego集群实例">6.3.4 装载RC副本文件，创建beego集群实例</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl apply -f golang-beego.yaml</span></span><br></pre></td></tr></table></figure><p>查看beego的web程序pods是否已经正常启动</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">itcast@master:~/working$ kubectl get pods</span><br><span class="line">NAME          READY   STATUS    RESTARTS   AGE</span><br><span class="line">beego-2wt7s   1/1     Running   0          2m47s</span><br><span class="line">beego-6jp8x   1/1     Running   0          2m47s</span><br><span class="line">beego-7bkvl   1/1     Running   0          2m47s</span><br><span class="line">beego-qjldn   1/1     Running   0          2m47s</span><br><span class="line">beego-vldmh   1/1     Running   0          2m47s</span><br><span class="line">mysql-kjdz8   1/1     Running   2          5d</span><br><span class="line">myweb-f7rt4   1/1     Running   2          5d</span><br><span class="line">myweb-jjxbp   1/1     Running   2          5d</span><br><span class="line">myweb-k8rmt   1/1     Running   2          5d</span><br><span class="line">myweb-rht8n   1/1     Running   2          5d</span><br><span class="line">myweb-wsgzw   1/1     Running   2          5d</span><br></pre></td></tr></table></figure><p>也可以查看beego程序的pods的正常输出日志</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">itcast@master:~/working$ kubectl <span class="built_in">log</span> beego-2wt7s     </span><br><span class="line"><span class="built_in">log</span> is DEPRECATED and will be removed <span class="keyword">in</span> a future version. Use logs instead.</span><br><span class="line">2019/06/24 09:19:12 root:123456@tcp(10.244.1.8:3306)/newsWeb?charset=utf8</span><br><span class="line">table `user` already exists, skip</span><br><span class="line">table `article` already exists, skip</span><br><span class="line">table `article_type` already exists, skip</span><br><span class="line">table `article_users` already exists, skip</span><br><span class="line">2019/06/24 09:19:12.241 [I] [asm_amd64.s:1337]  http server Running on http://:8080</span><br></pre></td></tr></table></figure><p>进入其中一个beego容器，查看环境变量是否和我们配置的一致</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">itcast@master:~/working$ kubectl  <span class="built_in">exec</span> -it beego-2wt7s -- sh</span><br><span class="line">/app <span class="comment"># env</span></span><br><span class="line">KUBERNETES_SERVICE_PORT=443</span><br><span class="line">KUBERNETES_PORT=tcp://10.96.0.1:443</span><br><span class="line">BEEGO_PORT_8080_TCP=tcp://10.107.31.251:8080</span><br><span class="line">HOSTNAME=beego-2wt7s</span><br><span class="line">MYWEB_SERVICE_HOST=10.106.98.4</span><br><span class="line">MYWEB_PORT_8080_TCP_ADDR=10.106.98.4</span><br><span class="line">SHLVL=1</span><br><span class="line">HOME=/root</span><br><span class="line">MYWEB_PORT_8080_TCP_PORT=8080</span><br><span class="line">MYWEB_PORT_8080_TCP_PROTO=tcp</span><br><span class="line">MYWEB_SERVICE_PORT=8080</span><br><span class="line">MYWEB_PORT=tcp://10.106.98.4:8080</span><br><span class="line">MYWEB_PORT_8080_TCP=tcp://10.106.98.4:8080</span><br><span class="line">TERM=xterm</span><br><span class="line">KUBERNETES_PORT_443_TCP_ADDR=10.96.0.1</span><br><span class="line">MYSQL_SERVICE_PASSWORD=123456</span><br><span class="line">PATH=/usr/<span class="built_in">local</span>/sbin:/usr/<span class="built_in">local</span>/bin:/usr/sbin:/usr/bin:/sbin:/bin</span><br><span class="line">KUBERNETES_PORT_443_TCP_PORT=443</span><br><span class="line">MYSQL_SERVICE_HOST=10.244.1.8</span><br><span class="line">KUBERNETES_PORT_443_TCP_PROTO=tcp</span><br><span class="line">MYSQL_SERVICE_USER=root</span><br><span class="line">BEEGO_SERVICE_HOST=10.107.31.251</span><br><span class="line">BEEGO_PORT_8080_TCP_ADDR=10.107.31.251</span><br><span class="line">MYSQL_SERVICE_PORT=3306</span><br><span class="line">KUBERNETES_SERVICE_PORT_HTTPS=443</span><br><span class="line">KUBERNETES_PORT_443_TCP=tcp://10.96.0.1:443</span><br><span class="line">BEEGO_PORT_8080_TCP_PORT=8080</span><br><span class="line">KUBERNETES_SERVICE_HOST=10.96.0.1</span><br><span class="line">BEEGO_PORT_8080_TCP_PROTO=tcp</span><br><span class="line">PWD=/app</span><br><span class="line">MYSQL_SERVICE_DATABASE=newsWeb</span><br><span class="line">BEEGO_PORT=tcp://10.107.31.251:8080</span><br><span class="line">BEEGO_SERVICE_PORT=8080</span><br><span class="line">/app <span class="comment"># env | grep MYSQL</span></span><br><span class="line">MYSQL_SERVICE_PASSWORD=123456</span><br><span class="line">MYSQL_SERVICE_HOST=10.244.1.8</span><br><span class="line">MYSQL_SERVICE_USER=root</span><br><span class="line">MYSQL_SERVICE_PORT=3306</span><br><span class="line">MYSQL_SERVICE_DATABASE=newsWeb</span><br></pre></td></tr></table></figure><h3 id="6-3-5-验证集群是否成功">6.3.5 验证集群是否成功</h3><ul><li><p>注册界面</p><p><a href="http://192.168.236.177:30080/register" target="_blank" rel="noopener">http://192.168.236.177:30080/register</a></p><p><img src="https://ybvip.oss-cn-shanghai.aliyuncs.com/blog/20200925181222.png" alt></p></li><li><p>登陆界面</p><p><a href="http://192.168.236.177:30080/login" target="_blank" rel="noopener">http://192.168.236.177:30080/login</a></p></li></ul><p>账号 密码：master master</p><ul><li><p>界面</p><p><img src="https://ybvip.oss-cn-shanghai.aliyuncs.com/blog/20200925181252.png" alt></p></li></ul><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script></div><div class="reward-container"><div>您的支持将鼓励我继续创作!</div><button disable="enable" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">打赏</button><div id="qr" style="display:none"><div style="display:inline-block"><img src="/images/wechatpay.png" alt="YB 微信支付"><p>微信支付</p></div><div style="display:inline-block"><img src="/images/alipay.png" alt="YB 支付宝"><p>支付宝</p></div></div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/K8S%E9%9B%86%E7%BE%A4%E5%AE%89%E8%A3%85/" rel="tag"><i class="fa fa-tag"></i> K8S集群安装</a> <a href="/tags/%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2/" rel="tag"><i class="fa fa-tag"></i> 容器化部署</a></div><div class="post-nav"><div class="post-nav-item"><a href="/posts/448312666/" rel="prev" title="安全框架/权限认证方案"><i class="fa fa-chevron-left"></i> 安全框架/权限认证方案</a></div><div class="post-nav-item"></div></div></footer></article></div></div><div class="comments" id="comments"></div></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#null"><span class="nav-text">一、Kubernetes概述</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1、什么是k8s"><span class="nav-text">1、什么是k8s</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2、Kubernetes解决了什么问题"><span class="nav-text">2、Kubernetes解决了什么问题</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#null"><span class="nav-text">二、环境</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-部署软件环境版本"><span class="nav-text">2.1 部署软件环境版本</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-Ubuntu搭建研发环境"><span class="nav-text">2.2 Ubuntu搭建研发环境</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3-Ubuntu安装过程"><span class="nav-text">2.3 Ubuntu安装过程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-1-创建虚拟机"><span class="nav-text">2.3.1 创建虚拟机</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-2-图形界面安装方式"><span class="nav-text">2.3.2 图形界面安装方式</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-4-修改主机名"><span class="nav-text">2.4 修改主机名</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-5-配置静态IP-永久有效-NAT模式"><span class="nav-text">2.5 配置静态IP(永久有效)(NAT模式)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-6-修改hosts"><span class="nav-text">2.6 修改hosts</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ip应用启动："><span class="nav-text">ip应用启动：</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#null"><span class="nav-text">三、Docker-CE安装及配置</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-Docker简介"><span class="nav-text">3.1 Docker简介</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-1-docker介绍"><span class="nav-text">3. 1.1 docker介绍</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-配置国内源"><span class="nav-text">3.2 配置国内源</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-1-基础准备"><span class="nav-text">3.2.1 基础准备</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-3-手动安装Docker-离线安装"><span class="nav-text">3.2.3 手动安装Docker(离线安装)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-3-启动Docker-ce"><span class="nav-text">3.3 启动Docker-ce</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-4-创建Docker用户组并添加当前用户"><span class="nav-text">3.4 创建Docker用户组并添加当前用户</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-5-申请阿里云镜像加速器"><span class="nav-text">3.5 申请阿里云镜像加速器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-6-docker配置国内镜像加速器"><span class="nav-text">3.6 docker配置国内镜像加速器</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#null"><span class="nav-text">四、Kubernetes 安装及部署</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#4-1-k8s安装环境准备"><span class="nav-text">4.1 k8s安装环境准备</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-1-配置并安装k8s国内源"><span class="nav-text">4.1.1 配置并安装k8s国内源</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-2-禁止基础设施"><span class="nav-text">4.1.2 禁止基础设施</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-2-k8s系统网络配置"><span class="nav-text">4.2 k8s系统网络配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-3-安装k8s"><span class="nav-text">4.3 安装k8s</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-4-验证k8s"><span class="nav-text">4.4 验证k8s</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#null"><span class="nav-text">五、创建企业Kubernetes多主机集群环境</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#5-1-创建两个节点-两个虚拟机"><span class="nav-text">5.1 创建两个节点(两个虚拟机)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-2-master和node基础配置"><span class="nav-text">5.2 master和node基础配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-1-给node配置hostname"><span class="nav-text">5.2.1 给node配置hostname</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-2-配置IP地址"><span class="nav-text">5.2.2 配置IP地址</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-3-修改hosts文件"><span class="nav-text">5.2.3 修改hosts文件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-3-配置Master节点"><span class="nav-text">5.3 配置Master节点</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-1-创建工作目录"><span class="nav-text">5.3.1 创建工作目录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-2-创建kubeadm-conf配置文件"><span class="nav-text">5.3.2 创建kubeadm.conf配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-3-拉取K8s必备的模块镜像"><span class="nav-text">5.3.3 拉取K8s必备的模块镜像</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-4-初始化kubernetes环境"><span class="nav-text">5.3.4 初始化kubernetes环境</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-5-验证kubernetes启动结果"><span class="nav-text">5.3.5 验证kubernetes启动结果</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-6-部署集群内部通信flannel网络"><span class="nav-text">5.3.6 部署集群内部通信flannel网络</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-4-配置Node"><span class="nav-text">5.4 配置Node</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-4-1-确认外部环境"><span class="nav-text">5.4.1 确认外部环境</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-4-2-配置k8s集群的Node主机环境"><span class="nav-text">5.4.2 配置k8s集群的Node主机环境</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#null"><span class="nav-text">六、应用实例</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#6-1-创建MySQL实例"><span class="nav-text">6.1 创建MySQL实例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-1-定义描述文件"><span class="nav-text">6.1.1 定义描述文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-2-加载ReplicationController副本控制器描述文件"><span class="nav-text">6.1.2 加载ReplicationController副本控制器描述文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-3-查看启动状态"><span class="nav-text">6.1.3 查看启动状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-4-网络异常解决方案-未出现问题可直接跳过"><span class="nav-text">6.1.4 网络异常解决方案(未出现问题可直接跳过)</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#解决办法：配置flannel网络"><span class="nav-text">解决办法：配置flannel网络</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-5-查看mysql实例集群状态"><span class="nav-text">6.1.5 查看mysql实例集群状态</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-2-创建Tomcat实例"><span class="nav-text">6.2 创建Tomcat实例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-2-1-定义描述文件"><span class="nav-text">6.2.1 定义描述文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-2-2-加载RC副本描述文件"><span class="nav-text">6.2.2 加载RC副本描述文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-2-3-创建服务副本"><span class="nav-text">6.2.3 创建服务副本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-2-4-部署服务"><span class="nav-text">6.2.4 部署服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-2-5-验证"><span class="nav-text">6.2.5 验证</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署面板-dashboard"><span class="nav-text">部署面板 dashboard</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-3-创建自定义的Beego-应用web程序集群"><span class="nav-text">6.3 创建自定义的Beego 应用web程序集群</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-3-1-初始化mysql"><span class="nav-text">6.3.1 初始化mysql</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-3-2-下载自定义的beego-docker-镜像"><span class="nav-text">6.3.2 下载自定义的beego-docker 镜像</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-3-3-创建beego的RC副本文件"><span class="nav-text">6.3.3 创建beego的RC副本文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-3-4-装载RC副本文件，创建beego集群实例"><span class="nav-text">6.3.4 装载RC副本文件，创建beego集群实例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-3-5-验证集群是否成功"><span class="nav-text">6.3.5 验证集群是否成功</span></a></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="YB" src="/images/avatar.gif"><p class="site-author-name" itemprop="name">YB</p><div class="site-description" itemprop="description">年岁是我的闹钟</div></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/Boy2ang" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Boy2ang" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i></a> </span><span class="links-of-author-item"><a href="mailto:ybvip@outlook.com" title="E-Mail → mailto:ybvip@outlook.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i></a> </span><span class="links-of-author-item"><a href="https://weibo.com/yourname" title="Weibo → https:&#x2F;&#x2F;weibo.com&#x2F;yourname" rel="noopener" target="_blank"><i class="fa fa-fw fa-weibo"></i></a> </span><span class="links-of-author-item"><a href="https://plus.google.com/yourname" title="Google → https:&#x2F;&#x2F;plus.google.com&#x2F;yourname" rel="noopener" target="_blank"><i class="fa fa-fw fa-google"></i></a> </span><span class="links-of-author-item"><a href="https://twitter.com/yourname" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;yourname" rel="noopener" target="_blank"><i class="fa fa-fw fa-twitter"></i></a> </span><span class="links-of-author-item"><a href="https://www.facebook.com/yourname" title="FB Page → https:&#x2F;&#x2F;www.facebook.com&#x2F;yourname" rel="noopener" target="_blank"><i class="fa fa-fw fa-facebook"></i></a></span></div></div><div><iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="350" height="100" src="//music.163.com/outchain/player?type=2&id=470795480&auto=1&height=66"></iframe></div><div class="links-of-blogroll motion-element links-of-blogroll-block"><div class="links-of-blogroll-title"><i class="fa fa-history fa-" aria-hidden="true"></i> 近期文章</div><ul class="links-of-blogroll-list"><li><a href="/" target="_blank"></a></li><li><a href="/" target="_blank"></a></li><li><a href="/" target="_blank"></a></li><li><a href="/" target="_blank"></a></li><li><a href="/" target="_blank"></a></li></ul></div><div><canvas id="canvas" style="width:60%">当前浏览器不支持canvas，请更换浏览器后再试</canvas></div><script>!function(){function t(t,e){for(var a=0;a<l[e].length;a++)for(var n=0;n<l[e][a].length;n++)1==l[e][a][n]&&(h.beginPath(),h.arc(14*(g+2)*t+2*n*(g+1)+(g+1),2*a*(g+1)+(g+1),g,0,2*Math.PI),h.closePath(),h.fill())}function e(){var t=[],e=/(\d)(\d):(\d)(\d):(\d)(\d)/.exec(new Date),a=[];a.push(e[1],e[2],10,e[3],e[4],10,e[5],e[6]);for(var r=c.length-1;r>=0;r--)a[r]!==c[r]&&t.push(r+"_"+(Number(c[r])+1)%10);for(var r=0;r<t.length;r++)n.apply(this,t[r].split("_"));c=a.concat()}function a(){for(var t=0;t<d.length;t++)d[t].stepY+=d[t].disY,d[t].x+=d[t].stepX,d[t].y+=d[t].stepY,(d[t].x>i+g||d[t].y>f+g)&&(d.splice(t,1),t--)}function n(t,e){for(var a=[1,2,3],n=["#3BE","#09C","#A6C","#93C","#9C0","#690","#FB3","#F80","#F44","#C00"],r=0;r<l[e].length;r++)for(var o=0;o<l[e][r].length;o++)if(1==l[e][r][o]){var h={x:14*(g+2)*t+2*o*(g+1)+(g+1),y:2*r*(g+1)+(g+1),stepX:Math.floor(4*Math.random()-2),stepY:-2*a[Math.floor(Math.random()*a.length)],color:n[Math.floor(Math.random()*n.length)],disY:1};d.push(h)}}function r(){o.height=100;for(var e=0;e<c.length;e++)t(e,c[e]);for(var e=0;e<d.length;e++)h.beginPath(),h.arc(d[e].x,d[e].y,g,0,2*Math.PI),h.fillStyle=d[e].color,h.closePath(),h.fill()}var l=[[[0,0,1,1,1,0,0],[0,1,1,0,1,1,0],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[0,1,1,0,1,1,0],[0,0,1,1,1,0,0]],[[0,0,0,1,1,0,0],[0,1,1,1,1,0,0],[0,0,0,1,1,0,0],[0,0,0,1,1,0,0],[0,0,0,1,1,0,0],[0,0,0,1,1,0,0],[0,0,0,1,1,0,0],[0,0,0,1,1,0,0],[0,0,0,1,1,0,0],[1,1,1,1,1,1,1]],[[0,1,1,1,1,1,0],[1,1,0,0,0,1,1],[0,0,0,0,0,1,1],[0,0,0,0,1,1,0],[0,0,0,1,1,0,0],[0,0,1,1,0,0,0],[0,1,1,0,0,0,0],[1,1,0,0,0,0,0],[1,1,0,0,0,1,1],[1,1,1,1,1,1,1]],[[1,1,1,1,1,1,1],[0,0,0,0,0,1,1],[0,0,0,0,1,1,0],[0,0,0,1,1,0,0],[0,0,1,1,1,0,0],[0,0,0,0,1,1,0],[0,0,0,0,0,1,1],[0,0,0,0,0,1,1],[1,1,0,0,0,1,1],[0,1,1,1,1,1,0]],[[0,0,0,0,1,1,0],[0,0,0,1,1,1,0],[0,0,1,1,1,1,0],[0,1,1,0,1,1,0],[1,1,0,0,1,1,0],[1,1,1,1,1,1,1],[0,0,0,0,1,1,0],[0,0,0,0,1,1,0],[0,0,0,0,1,1,0],[0,0,0,1,1,1,1]],[[1,1,1,1,1,1,1],[1,1,0,0,0,0,0],[1,1,0,0,0,0,0],[1,1,1,1,1,1,0],[0,0,0,0,0,1,1],[0,0,0,0,0,1,1],[0,0,0,0,0,1,1],[0,0,0,0,0,1,1],[1,1,0,0,0,1,1],[0,1,1,1,1,1,0]],[[0,0,0,0,1,1,0],[0,0,1,1,0,0,0],[0,1,1,0,0,0,0],[1,1,0,0,0,0,0],[1,1,0,1,1,1,0],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[0,1,1,1,1,1,0]],[[1,1,1,1,1,1,1],[1,1,0,0,0,1,1],[0,0,0,0,1,1,0],[0,0,0,0,1,1,0],[0,0,0,1,1,0,0],[0,0,0,1,1,0,0],[0,0,1,1,0,0,0],[0,0,1,1,0,0,0],[0,0,1,1,0,0,0],[0,0,1,1,0,0,0]],[[0,1,1,1,1,1,0],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[0,1,1,1,1,1,0],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[0,1,1,1,1,1,0]],[[0,1,1,1,1,1,0],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[0,1,1,1,0,1,1],[0,0,0,0,0,1,1],[0,0,0,0,0,1,1],[0,0,0,0,1,1,0],[0,0,0,1,1,0,0],[0,1,1,0,0,0,0]],[[0,0,0,0,0,0,0],[0,0,1,1,1,0,0],[0,0,1,1,1,0,0],[0,0,1,1,1,0,0],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0],[0,0,1,1,1,0,0],[0,0,1,1,1,0,0],[0,0,1,1,1,0,0],[0,0,0,0,0,0,0]]],o=document.getElementById("canvas");if(o.getContext){var h=o.getContext("2d"),f=100,i=700;o.height=f,o.width=i,h.fillStyle="#f00",h.fillRect(10,10,50,50);var c=[],d=[],g=o.height/20-1;!function(){var t=/(\d)(\d):(\d)(\d):(\d)(\d)/.exec(new Date);c.push(t[1],t[2],10,t[3],t[4],10,t[5],t[6])}(),clearInterval(v);var v=setInterval(function(){e(),a(),r()},50)}}()</script></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; 2018 – <span itemprop="copyrightYear">2020</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">YB</span></div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="site-uv">我的第 <span class="busuanzi-value" id="busuanzi_value_site_uv"></span> 位朋友， </span><span class="agesicon"><span><span class="site-pv">历经 <span class="busuanzi-value" id="busuanzi_value_site_pv"></span> 次回眸才与你相遇。</span></span></span></div><script>function leancloudSelector(url) {
    return document.getElementById(url).querySelector('.leancloud-visitors-count');
  }
  if (CONFIG.page.isPost) {
    function addCount(Counter) {
      var visitors = document.querySelector('.leancloud_visitors');
      var url = visitors.getAttribute('id').trim();
      var title = visitors.getAttribute('data-flag-title').trim();

      Counter('get', `/classes/Counter?where=${JSON.stringify({ url })}`)
        .then(response => response.json())
        .then(({ results }) => {
          if (results.length > 0) {
            var counter = results[0];
              leancloudSelector(url).innerText = counter.time + 1;
            Counter('put', '/classes/Counter/' + counter.objectId, { time: { '__op': 'Increment', 'amount': 1 } })
              .then(response => response.json())
              .catch(error => {
                console.log('Failed to save visitor count', error);
              })
          } else {
              Counter('post', '/classes/Counter', { title: title, url: url, time: 1 })
                .then(response => response.json())
                .then(() => {
                  leancloudSelector(url).innerText = 1;
                })
                .catch(error => {
                  console.log('Failed to create', error);
                });
          }
        })
        .catch(error => {
          console.log('LeanCloud Counter Error', error);
        });
    }
  } else {
    function showTime(Counter) {
      var visitors = document.querySelectorAll('.leancloud_visitors');
      var entries = [...visitors].map(element => {
        return element.getAttribute('id').trim();
      });

      Counter('get', `/classes/Counter?where=${JSON.stringify({ url: { '$in': entries } })}`)
        .then(response => response.json())
        .then(({ results }) => {
          if (results.length === 0) {
            document.querySelectorAll('.leancloud_visitors .leancloud-visitors-count').forEach(element => {
              element.innerText = 0;
            });
            return;
          }
          for (let item of results) {
            let { url, time } = item;
            leancloudSelector(url).innerText = time;
          }
          for (let url of entries) {
            var element = leancloudSelector(url);
            if (element.innerText == '') {
              element.innerText = 0;
            }
          }
        })
        .catch(error => {
          console.log('LeanCloud Counter Error', error);
        });
    }
  }

  fetch('https://app-router.leancloud.cn/2/route?appId=iknoyPikdeJOSWsuQYwaAT8s-gzGzoHsz')
    .then(response => response.json())
    .then(({ api_server }) => {
      var Counter = (method, url, data) => {
        return fetch(`https://${api_server}/1.1${url}`, {
          method: method,
          headers: {
            'X-LC-Id': 'iknoyPikdeJOSWsuQYwaAT8s-gzGzoHsz',
            'X-LC-Key': 'a7k7hVy9GzeC2qRlWDGktNRn',
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });
      };
      if (CONFIG.page.isPost) {
        if (CONFIG.hostname !== location.hostname) return;
        addCount(Counter);
      } else if (document.querySelectorAll('.post-title-link').length >= 1) {
        showTime(Counter);
      }
    });</script></div></footer></div><script color="0,0,255" opacity="0.5" zindex="-1" count="150" src="/lib/canvas-nest/canvas-nest.min.js"></script><script src="/lib/anime.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script src="/js/local-search.js"></script><script>NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
  var GUEST = ['nick', 'mail', 'link'];
  var guest = 'nick,mail,link';
  guest = guest.split(',').filter(item => {
    return GUEST.includes(item);
  });
  new Valine({
    el: '#comments',
    verify: false,
    notify: false,
    appId: 'iknoyPikdeJOSWsuQYwaAT8s-gzGzoHsz',
    appKey: 'a7k7hVy9GzeC2qRlWDGktNRn',
    placeholder: "说点什么吧。",
    avatar: 'mm',
    meta: guest,
    pageSize: '10' || 10,
    visitor: false,
    lang: '' || 'zh-cn',
    path: location.pathname,
    recordIP: false,
    serverURLs: ''
  });
}, window.Valine);</script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/moment.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment-precise-range-plugin@1.3.0/moment-precise-range.min.js"></script><script>function timer() {
      var ages = moment.preciseDiff(moment(),moment(20181001,"YYYYMMDD"));
      //去除时分秒信息
      ages = ages.replace(/\s?\d{0,2}\s+hours?/, "");
      ages = ages.replace(/\s?\d{0,2}\s+minutes?/, "");
      ages = ages.replace(/\s?\d{0,2}\s+seconds?/, "");
      //将年月日转换为中文
      ages = ages.replace(/years?/, "年");
      ages = ages.replace(/months?/, "月");
      ages = ages.replace(/days?/, "天");
      ages = ages.replace(/\d+/g, '<span style="color:#1094e8">$&</span>');
      span.innerHTML = ` &nbsp; | &nbsp;我已在此等候你 ${ages}`;
    }
    var span = document.createElement("span");
    //插入到agesicon之后
    var agesicon = document.querySelector(".agesicon");
    document.querySelector(".copyright").insertBefore(span, agesicon.nextSibling);
    timer();</script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,log:!1,model:{jsonPath:"/live2dw/assets/koharu.model.json"},display:{position:"right",width:200,height:400},mobile:{show:!0},react:{opacity:.7}})</script></body></html><!-- rebuild by neat -->